{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "This cloudformation template creates resources required to set up a golden ami pipeline.",

    "Parameters": {

      "tenableApiKey": {
             "Type": "String",
             "Default": "<ENTER Tenable API Key>",
             "NoEcho": "true",
             "Description": "Please enter the tenable API Key for  your AMI for assessment. You get to override this later by editing the SSM parameter "
           },

      "tenableSecretKey": {
              "Type": "String",
              "Default": "123",
              "NoEcho": "true",
              "Description": "Please enter the tenable API Secret Key for your AMI for assessment. You get to override this later by editing the SSM parameter "
            },

      "tenableScanner": {
                "Type": "String",
                "Default": "<ENTER tenable SCANNER NAME>",
                "Description": "Please enter the tenable Scanner ID for the tenable agent which will be installed on your AMI for assessment. You get to override this later by editing the SSM parameter "
              },

      "tenableScanType": {
                 "Type": "String",
                 "Default": "Basic Network Scan",
                 "Description": "Please enter the tenableScanType for your AMI for assessment. You get to override this later by editing the SSM parameter ",
                 "AllowedValues": ["PCI Quarterly External Scan",
                                   "WannaCry Ransomware Detection",
                                   "Intel AMT Security Bypass Detection",
                                   "Host Discovery",
                                   "Basic Network Scan",
                                   "Credentialed Patch Audit",
                                   "Legacy Web App Scan",
                                   "Malware Scan",
                                   "Mobile Device Scan",
                                   "MDM Config Audit",
                                   "Policy Compliance Auditing",
                                   "Internal PCI Network Scan",
                                   "Offline Config Audit",
                                   "Audit Cloud Infrastructure",
                                   "SCAP and OVAL Auditing",
                                   "Bash Shellshock Detection",
                                   "GHOST (glibc) Detection",
                                   "DROWN Detection",
                                   "Badlock Detection",
                                   "Shadow Brokers Scan",
                                   "Spectre and Meltdown Detection",
                                   "Advanced Network Scan",
                                   "Advanced Agent Scan",
                                   "Basic Agent Scan",
                                   "Policy Compliance Auditing",
                                   "SCAP and OVAL Agent Auditing",
                                   "Malware Scan",
                                   "Web App Overview",
                                   "Web App Scan"]
               },

      "tenableApiUrl": {
        "Default": "https://cloud.tenable.com",
        "Description": "Your tenable URL for accessing API",
        "Type": "String"
        },

      "productName": {
            "Type": "String",
            "Default": "ProductName-ProductVersion",
            "Description": "ProductName-ProductVersion combination of the product for which you intend to use the pipeline. You get to override this later when you trigger automation workflow. "
          },

      "productOSAndVersion": {
            "Type": "String",
            "Default": "OperatingSystemName-OperatingSystemVersion",
            "Description": "Operating system name and OS version. You get to override this later when you trigger automation workflow."
          },

      "buildVersion": {
            "Type": "String",
            "Default": "1",
            "Description": "Build-Version corresponding to your product. Note - This is just a default value, you get to override this later when you trigger automation workflow."
          },

      "cidrVPC" : {
            "Description" : "An available CIDR block for creating a new VPC. The size of the VPC should be big enough to hold instances of all your golden AMIs at a time",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "10.0.0.0/16",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
          },

      "cidrPrivateSubnet" : {
            "Description" : "An available CIDR block for creating a new VPC. The size of the VPC should be big enough to hold instances of all your golden AMIs at a time",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "10.0.1.0/24",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
          },

      "cidrPublicSubnet" : {
            "Description" : "An available CIDR block for creating a new VPC. The size of the VPC should be big enough to hold instances of all your golden AMIs at a time",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "10.0.2.0/24",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
          },

      "ApproverUserIAMARN1": {
            "Type": "String",
            "Default": "",
            "Description": "IAM ARN of the Golden AMI approver. The approver must have AmazonSSMAutomationApproverAccess policy associated with it's IAM Profile ."
        },
        
      "ApproverUserIAMARN2": {
            "Type": "String",
            "Default": "",
            "Description": "IAM ARN of the Golden AMI approver. The approver must have AmazonSSMAutomationApproverAccess policy associated with it's IAM Profile ."
        },

      "ApproverUserIAMARN3": {
            "Type": "String",
            "Default": "",
            "Description": "IAM ARN of the Golden AMI approver. The approver must have AmazonSSMAutomationApproverAccess policy associated with it's IAM Profile ."
        },

      "EmailID": {
            "Type": "String",
            "Default": "myemail@mycompany.com",
            "AllowedPattern": "([a-zA-Z0-9_\\-\\.]+)@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.)|(([a-zA-Z0-9\\-]+\\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\\]?)",
            "Description": "Your email ID for receiving Tenable.io assessment results and golden AMI creation notification."

           },

      "instanceType":
            {
               "Type": "String",
            "Default": "t2.large",
            "Description": "Specify the the InstanceType compatible with all your golden AMIs. This InstanceType will be used for launching continuous vulnerability assessment of golden AMIs."
                },

      "continuousInspectionFrequency": {
            "Type": "String",
            "Default": "rate(1 day)",
            "Description": "Frequency for setting up continuous inspection of your AMIs. For syntax, check - https://docs.aws.amazon.com/lambda/latest/dg/tutorial-scheduled-events-schedule-expressions.html"
            },

      "MetadataJSON":{
               "Type":"String",
               "Default":"{\\\"Account_ID_1\\\":\\\"region_1,region_2\\\"}",
               "Description": "Metadata of accounts and regions for distributing the golden AMI."
            },

      "roleName":{
               "Type":"String",
               "Default":"goldenAMICrossAccountRole",
               "Description": "Cross account role suffix for managing Golden AMI metadata Parameters in child account(s). This role needs to exist in each account specified in MetadataJSON parameter."
            }
    },

    "Resources": {

      "tenableApiKeyResource": {
         "Type": "AWS::SSM::Parameter",
         "Properties": {
            "Name": "/GoldenAMI/tenable/tenableApiKey",
            "Type": "String",
            "Value": {"Ref":"tenableApiKey"},
            "Description": "SSM Parameter for tenable Username."
         }
      },

      "tenableSecretKeyResource": {
         "Type": "AWS::SSM::Parameter",
         "Properties": {
            "Name": "/GoldenAMI/tenable/tenableSecretKey",
            "Type": "String",
            "Value": {"Ref":"tenableSecretKey"},
            "Description": "SSM Parameter for tenable Password."
         }
      },

      "tenableScannerName": {
         "Type": "AWS::SSM::Parameter",
         "Properties": {
            "Name": "/GoldenAMI/tenable/tenableScannerName",
            "Type": "String",
            "Value": {"Ref":"tenableScanner"},
            "Description": "SSM Parameter for tenable Scanner Name."
         }
      },

      "tenableScanTypeResource": {
         "Type": "AWS::SSM::Parameter",
         "Properties": {
            "Name": "/GoldenAMI/tenable/tenableScanType",
            "Type": "String",
            "Value": {"Ref":"tenableScanType"},
            "Description": "SSM Parameter for tenable SCAN TYPE."
            }
          },

      "VPC": {
          "Type": "AWS::EC2::VPC",
          "Properties": {
            "EnableDnsSupport": "true",
            "EnableDnsHostnames": "true",
            "CidrBlock": {"Ref":"cidrVPC"},
            "Tags":[
                {"Key" : "Name", "Value" : "GoldenAMIPipelineVPC"} 
              ]
            }
          },

      "subnetPrivate": {
          "Type": "AWS::EC2::Subnet",
          "Properties": {
            "CidrBlock": {"Ref":"cidrPrivateSubnet"},
            "VpcId": {
              "Ref": "VPC"
            },
            "Tags":[
                {"Key" : "Name", "Value" : "GoldenAMIPipelinePrivateSubnet"} 
            ]
          }
        },

      "subnetPublic": {
          "Type": "AWS::EC2::Subnet",
          "Properties": {
            "MapPublicIpOnLaunch" : true,
            "CidrBlock": {"Ref":"cidrPublicSubnet"},
            "VpcId": {
              "Ref": "VPC"
              },
            "Tags":[
                {"Key" : "Name", "Value" : "GoldenAMIPipelinePublicSubnet"}
              ]
            }
          },

      "InternetGateway": {
          "Type": "AWS::EC2::InternetGateway",
          "Properties": {
            "Tags":[
                {"Key" : "Name", "Value" : "GoldenAMIPipelineInternetGateway"}
              ]
          }
          },

      "PublicVPCGatewayAttachment": {
          "Type": "AWS::EC2::VPCGatewayAttachment",
          "Properties": {
            "VpcId": {
              "Ref": "VPC"
            },
            "InternetGatewayId": {
              "Ref": "InternetGateway"
              }
            }
          },

      "PublicRouteTable": {
          "Type": "AWS::EC2::RouteTable",
          "Properties": {
            "VpcId": {
              "Ref": "VPC"
            },
            "Tags":[
                {"Key" : "Name", "Value" : "GoldenAMIPipelinePublicRouteTable"}
              ]
          }
        },

      "PublicRoute": {
          "Type": "AWS::EC2::Route",
          "DependsOn": "PublicVPCGatewayAttachment",
          "Properties": {
            "RouteTableId": {
              "Ref": "PublicRouteTable"
            },
            "DestinationCidrBlock": "0.0.0.0/0",
            "GatewayId": {
              "Ref": "InternetGateway"
              }
            }
          },

      "PublicSubnetRouteTableAssociation": {
          "Type": "AWS::EC2::SubnetRouteTableAssociation",
          "Properties": {
            "SubnetId": {
              "Ref": "subnetPublic"
            },
            "RouteTableId": {
              "Ref": "PublicRouteTable"
            }
          }
        },

      "NAT" : {
          "DependsOn" : "PublicVPCGatewayAttachment",
          "Type" : "AWS::EC2::NatGateway",
          "Properties" : {
            "AllocationId" : { "Fn::GetAtt" : ["EIP", "AllocationId"]},
            "SubnetId" : { "Ref" : "subnetPublic"},
            "Tags":[
                {"Key" : "Name", "Value" : "GoldenAMIPipelineNATGateway"}
              ]
          }
        },

      "PrivateRouteTable": {
          "Type": "AWS::EC2::RouteTable",
          "Properties": {
            "VpcId": {
              "Ref": "VPC"
              },
            "Tags":[
                {"Key" : "Name", "Value" : "GoldenAMIPipelinePrivateRouteTable"}
              ]
            }
          },

      "EIP" : {
          "Type" : "AWS::EC2::EIP",
          "Properties" : {
            "Domain" : "vpc"
                }
            },

      "PrivateRoute": {
          "Type": "AWS::EC2::Route",
          "DependsOn": "PublicVPCGatewayAttachment",
          "Properties" :
          {
            "RouteTableId" : { "Ref" : "PrivateRouteTable" },
            "DestinationCidrBlock" : "0.0.0.0/0",
            "NatGatewayId" : { "Ref" : "NAT" }
            }
          },

      "PrivateSubnetRouteTableAssociation": {
          "Type": "AWS::EC2::SubnetRouteTableAssociation",
          "Properties": {
            "SubnetId": {
              "Ref": "subnetPrivate"
            },
            "RouteTableId": {
              "Ref": "PrivateRouteTable"
            }
          }
        },

      "secGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
              "VpcId": {
                "Ref": "VPC"
              },
              "GroupDescription": "Allow scanner traffic",
              "SecurityGroupIngress": [
                {
                    "IpProtocol": "tcp",
                    "CidrIp": {"Ref":"cidrVPC"},
                    "ToPort": 22,
                    "FromPort": 22
                },
                {
                    "IpProtocol": "tcp",
                    "CidrIp": {"Ref":"cidrVPC"},
                    "ToPort": 80,
                    "FromPort": 80
                },
                {
                    "IpProtocol": "tcp",
                    "CidrIp": {"Ref":"cidrVPC"},
                    "ToPort": 443,
                    "FromPort": 80
                }
              ],
              "Tags":[
                {"Key" : "Name", "Value" : "GoldenAMIPipelineSecurityGroup"}
              ]
            }
          },

      "GoldenAMIConfigBucket": {
                  "Type": "AWS::S3::Bucket",
                  "Properties": {
                      "VersioningConfiguration": {
                          "Status": "Enabled"
                      },
                      "BucketEncryption":
                      {
                        "ServerSideEncryptionConfiguration" : [{
                        "ServerSideEncryptionByDefault" : {"SSEAlgorithm":"AES256"}
                    }]
                    }

                  }
              },

      "GoldenAmiConfigBucketPolicy": {
                  "Type": "AWS::S3::BucketPolicy",
                  "DependsOn": "ManagedInstanceRole",
                  "Properties": {
                      "Bucket": {
                          "Ref": "GoldenAMIConfigBucket"
                      },
                      "PolicyDocument": {
                          "Statement": [
                              {
                                  "Action": [
                                      "s3:*"
                                  ],
                                  "Effect": "Allow",
                                  "Resource": [
                                      {
                                          "Fn::Join": [
                                              "",
                                              [
                                                  "arn:aws:s3:::",
                                                  {
                                                      "Ref": "GoldenAMIConfigBucket"
                                                  },
                                                  "/*"
                                              ]
                                          ]
                                      },
                                      {
                                          "Fn::Join": [
                                              "",
                                              [
                                                  "arn:aws:s3:::",
                                                  {
                                                      "Ref": "GoldenAMIConfigBucket"
                                                  }
                                              ]
                                          ]
                                      }
                                  ],
                                  "Principal": {
                                      "AWS": [
                                          {
                                              "Fn::GetAtt": [
                                                  "ManagedInstanceRole",
                                                  "Arn"
                                              ]
                                          },
                                          {
                                              "Fn::GetAtt": [
                                                  "AutomationServiceRole",
                                                  "Arn"
                                              ]
                                          },
                                          {
                                               "Fn::GetAtt": [
                                                  "PublishAMILambdaRole",
                                                  "Arn"
                                              ]
                                          }
                                      ]
                                  }
                              }
                          ]
                      }
                  }
              },

      "SSMConfigPolicy": {
             "Type": "AWS::IAM::Policy",
             "DependsOn": "ManagedInstanceRole",
             "Properties": {
                "PolicyName": "SSM-Policy",
                "PolicyDocument": {
                   "Version" : "2012-10-17",
                   "Statement": [
                      { "Effect": "Allow", "Action": "ssm:*", "Resource": "arn:aws:ssm:*:*:parameter/*" }
                   ]
                },
                "Roles": [ { "Ref": "ManagedInstanceRole" } ]
             }
          },

      "PublishAMILambdaRole": {
                  "Type": "AWS::IAM::Role",
                  "Properties": {
                      "ManagedPolicyArns": [
                          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"],
                      "AssumeRolePolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Principal": {
                                      "Service": [
                                          "lambda.amazonaws.com"
                                      ]
                                  },
                                  "Action": [
                                      "sts:AssumeRole"
                                  ]
                              }
                          ]
                      },
                      "Path": "/",
                      "Policies": [
                          {
                              "PolicyName": "PublishAMILambdaPolicy",
                              "PolicyDocument": {
                                  "Version": "2012-10-17",
                                  "Statement": [
                                      {
                                          "Effect": "Allow",
                                          "Action": [
                                              "ssm:GetParameter*"
                                          ],
                                          "Resource": { "Fn::Join":
                                            [
                                                "",
                                                [
                                                    "arn:aws:ssm:", "*",
                                                    ":",
                                                    {
                                                        "Ref":"AWS::AccountId"
                                                    },
                                                    ":parameter/GoldenAMI/*"
                                                ]
                                            ]}
                                      },
                                      {
                                "Effect": "Allow",
                                "Action": [
                                    "s3:GetObject*",
                                    "s3:PutObject*"],
                                "Resource": [
                                { "Fn::Join":["",["arn:aws:s3:::",{"Ref": "GoldenAMIConfigBucket"},"/*"]]
                                }]
                          },
                          {
                                "Effect": "Allow",
                                "Action": [
                                    "servicecatalog:SearchProductsAsAdmin",
                                    "servicecatalog:CreateProvisioningArtifact",
                                    "servicecatalog:CreateProduct",
                                    "servicecatalog:TagResource",
                                    "cloudformation:ValidateTemplate"
                                    ],
                                "Resource": "*"
                          }

                                  ]
                              }
                          }

                      ]
                  }
              },

      "PublishAMILambda": {
                  "Type": "AWS::Lambda::Function",
                  "Properties": {
                      "Role": {
                          "Fn::GetAtt": [
                              "PublishAMILambdaRole",
                              "Arn"
                          ]
                      },
                      "Code": {
                          "ZipFile": {
                              "Fn::Join": [
                                  "\n",
                                  [
                                      "import boto3",
                                      "import json",
                                      "from dateutil import parser",
                                      "import dateutil",
                                      "import datetime",
                                      "import collections",
                                      "import os",
                                      "import time",
                                      "def lambda_handler(event, context):",
                                      "    sourceRegion = os.environ['AWS_DEFAULT_REGION']",
                                      "    s3 = boto3.resource('s3')",
                                      "    prodName=event['productNameAndVersion']",
                                      "    prodOS=event['productOSAndVersion']",
                                      "    bucket =event['bucketName']",
                                      "    s3FilePrefix=event['templateFileName']",
                                      "    version=event['versionToBeCreated']",
                                      "    amiRegionMappingParamName =event['amiRegionMappingParamName']",
                                      "    filepath='/tmp/'+s3FilePrefix",
                                      "    object=s3.Object(bucket,s3FilePrefix)",
                                      "    text=object.get()[\"Body\"].read().decode('utf-8') ",
                                      "    amiIDParamPath = '/GoldenAMI/'+prodOS+'/'+prodName+'/'+event['versionToBeCreated']",
                                      "    text=text.replace('AMI_ID_TO_REPLACE', amiIDParamPath)",
                                      "    with open(filepath, mode='w',encoding='utf-8') as file:",
                                      "        file.write(text)",
                                      "    s3.meta.client.upload_file(filepath,bucket,s3FilePrefix+'/versions/'+version)",
                                      "    ssm = boto3.client('ssm',os.environ['AWS_DEFAULT_REGION'])",
                                      "    amiIDRegionMapping =  ssm.get_parameter(Name=amiRegionMappingParamName)['Parameter']['Value']",
                                      "    mappingJSON = json.loads(amiIDRegionMapping)",
                                      "    for region, amiID in mappingJSON.items():",
                                      "        sc = boto3.client('servicecatalog',region)",
                                      "        scProduct=''",
                                      "        products = sc.search_products_as_admin(ProductSource='ACCOUNT')",
                                      "        for product in products['ProductViewDetails']:",
                                      "            productName = product['ProductViewSummary']['Name']",
                                      "            if productName == prodName+'-'+prodOS:    ",
                                      "                scProduct=product['ProductViewSummary']['ProductId']",
                                      "                sc.create_provisioning_artifact(ProductId=scProduct,Parameters={'Name': version,'Description': 'This is version '+version,'Info': {'LoadTemplateFromURL': 'https://s3.amazonaws.com/'+bucket+'/'+s3FilePrefix+'/versions/'+version},'Type': 'CLOUD_FORMATION_TEMPLATE'},IdempotencyToken=str(round(time.time() * 1000)))",
                                      "        if scProduct == '':",
                                      "            print('SC product not found, creating a product')",
                                      "            result = sc.create_product(Name=prodName+'-'+prodOS,Owner='CCOE',ProductType='CLOUD_FORMATION_TEMPLATE', Description='This product can be used to launch '+prodName+' in '+prodOS+' environment.', Tags=[{'Key': 'ProductName','Value': prodName+'-'+prodOS}],ProvisioningArtifactParameters={'Name':version,'Description': 'This is version '+version,'Info': {'LoadTemplateFromURL': 'https://s3.amazonaws.com/'+bucket+'/'+s3FilePrefix+'/versions/'+version},'Type': 'CLOUD_FORMATION_TEMPLATE'},IdempotencyToken=str(round(time.time() * 1000)))",
                                      "    return 'Done';"
                                  ]
                              ]
                          }
                      },
                      "Runtime": "python3.6",
                      "Timeout": 300,
                      "Handler": "index.lambda_handler",
                      "MemorySize": 512
                  }
              },

      "DecommissionAMIVersionLambdaRole": {
                  "Type": "AWS::IAM::Role",
                  "Properties": {
                      "ManagedPolicyArns": [
                          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                      ],
                      "AssumeRolePolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Principal": {
                                      "Service": [
                                          "lambda.amazonaws.com"
                                      ]
                                  },
                                  "Action": [
                                      "sts:AssumeRole"
                                  ]
                              }
                          ]
                      },
                      "Path": "/",
                      "Policies": [
                          {
                              "PolicyName": "DecommissionAMIVersionLambdaPolicy",
                              "PolicyDocument": {
                                  "Version": "2012-10-17",
                                  "Statement": [
                                      {
                                          "Effect": "Allow",
                                          "Action": [
                                              "ssm:GetParameter*",
                                              "ssm:PutParameter*",
                                              "ssm:delete*"
                                          ],
                                          "Resource": { "Fn::Join":
                                                      [
                                                          "",
                                                          [
                                                              "arn:aws:ssm:", "*",
                                                              ":",
                                                              {
                                                                  "Ref":"AWS::AccountId"
                                                              },
                                                              ":parameter/GoldenAMI/*"
                                                          ]
                                                      ]}
                                      },
                                      {
                                          "Effect": "Allow",
                                          "Action": ["s3:delete*",
                                              "s3:get*"],
                                          "Resource": [
                                              {
                                                  "Fn::Join": [
                                                      "",
                                                      [
                                                          "arn:aws:s3:::",
                                                          {
                                                              "Ref": "GoldenAMIConfigBucket"
                                                          },
                                                          "/*"
                                                      ]
                                                  ]
                                              },
                                              {
                                                  "Fn::Join": [
                                                      "",
                                                      [
                                                          "arn:aws:s3:::",
                                                          {
                                                              "Ref": "GoldenAMIConfigBucket"
                                                          }
                                                      ]
                                                  ]
                                              }
                                            ]
                                      },
                                       {

                                          "Effect": "Allow",
                                          "Action": "sts:AssumeRole",
                                         "Resource": {
                                           "Fn::Join": [
                                               "",
                                               [
                                                 "arn:aws:iam::*:role/",
                                                 {
                                                   "Ref":"roleName"
                                                 }
                                               ]
                                             ]
                                           }
                                        },
                                       {
                                          "Effect": "Allow",
                                          "Action": [
                                              "ec2:DeregisterImage",
                                              "ec2:DescribeSnapshots",
                                              "ec2:DeleteSnapshot",
                                              "sc:list*",
                                              "sc:search*",
                                              "servicecatalog:SearchProductsAsAdmin",
                                              "servicecatalog:ListProvisioningArtifacts",
                                              "servicecatalog:DeleteProduct",
                                              "servicecatalog:DeleteProvisioningArtifact"                                    ],
                                          "Resource": "*"
                                      }
                                  ]
                              }
                          }
                      ]
                  }
              },

      "DecommissionAMIVersionLambda": {
                  "Type": "AWS::Lambda::Function",
                  "Properties": {
                      "Role": {
                          "Fn::GetAtt": [
                              "DecommissionAMIVersionLambdaRole",
                              "Arn"
                          ]
                      },
                      "Code": {
                          "ZipFile": {
                              "Fn::Join": [
                                  "",
                                  [
                                      "\n","import boto3",
                                      "\n","import json",
                                      "\n","from dateutil import parser",
                                      "\n","import dateutil",
                                      "\n","import datetime",
                                      "\n","import collections",
                                      "\n","import os",
                                      "\n","import time",
                                      "\n","import botocore",

                                      "\n","def lambda_handler(event, context):",
                                      "\n","    sourceRegion = os.environ['AWS_DEFAULT_REGION']",
                                      "\n","    s3 = boto3.resource('s3')",
                                      "\n","    prodName=event['productNameAndVersion']",
                                      "\n","    prodOS=event['productOSAndVersion']",
                                      "\n","    bucketName =event['bucketName']",
                                      "\n","    s3FilePrefix=event['templateFileName']",
                                      "\n","    version=event['versionToBeDeleted']",
                                      "\n","    amiRegionMappingParamName =event['amiRegionMappingParamName']",
                                      "\n","    prefix='/GoldenAMI/'+prodOS+'/'+prodName+'/'+version",
                                      "\n","    s3 = boto3.resource('s3')",
                                      "\n","    masterAmis='/GoldenAMI/latest'",
                                      "\n","    bucket = s3.Bucket(bucketName)",
                                      "\n","    bucket.delete_objects(Delete={'Objects': [{'Key': s3FilePrefix+'/versions/'+version } ] })",
                                      "\n","    ssm = boto3.client('ssm',sourceRegion)",
                                      "\n","    amiIDRegionMapping=''",
                                      "\n","    params= [prefix+'/latestInstance',prefix+'/LatestAssessmentRunARN',prefix+'/NumCVEs',prefix+'/assessmentLink',prefix+'/assessmentTemplateARN']",
                                      "\n","    try:",
                                      "\n","        amiIDRegionMapping =  ssm.get_parameter(Name=amiRegionMappingParamName)['Parameter']['Value']",
                                      "\n","    except botocore.exceptions.ClientError as e:",
                                      "\n","        if e.response['Error']['Code'] == 'ParameterNotFound':",
                                      "\n","            amiID= ssm.get_parameter(Name=prefix)['Parameter']['Value']",
                                      "\n","            ec2 = boto3.client('ec2')",
                                      "\n","            ec2.deregister_image(ImageId=amiID)",
                                      "\n","            time.sleep(5)",
                                      "\n","            snaps = ec2.describe_snapshots()",
                                      "\n","            for snap in snaps['Snapshots']: ",
                                      "\n","                if amiID in snap['Description']:",
                                      "\n","                    ec2.delete_snapshot(SnapshotId=snap['SnapshotId'])",
                                      "\n","            ssm.delete_parameters(Names=params)",
                                      "\n","            try:",
                                      "\n","                temp =  ssm.get_parameter(Name=masterAmis)['Parameter']['Value']",
                                      "\n","                temp= temp.replace(amiID+',','').replace(','+amiID,'').replace(amiID,'')",
                                      "\n","                if len(temp) == 0:",
                                      "\n","                    ssm.delete_parameters(Names=[masterAmis])",
                                      "\n","                else:",
                                      "\n","                    ssm.put_parameter(Name=masterAmis,Type='String', Value=temp,Overwrite=True)",
                                      "\n","                return 'Done'",
                                      "\n","            except botocore.exceptions.ClientError as e:",
                                      "\n","                if e.response['Error']['Code'] == 'ParameterNotFound':",
                                      "\n","                    print('This indicates that the active amis are not present')",
                                      "\n","            return 'Done'",
                                      "\n","    mappingJSON = json.loads(amiIDRegionMapping)",
                                      "\n","    for region,amiID in mappingJSON.items():",
                                      "\n","        sc = boto3.client('servicecatalog',region)",
                                      "\n","        products = sc.search_products_as_admin(ProductSource='ACCOUNT')",
                                      "\n","        for product in products['ProductViewDetails']:",
                                      "\n","            productName = product['ProductViewSummary']['Name']",
                                      "\n","            if productName == prodName+'-'+prodOS:",
                                      "\n","                productID=product['ProductViewSummary']['ProductId']",
                                      "\n","                provisioningArtifacts = sc.list_provisioning_artifacts(ProductId=productID)['ProvisioningArtifactDetails']",
                                      "\n","                if len(provisioningArtifacts) == 1:",
                                      "\n","                    sc.delete_product(Id=productID)",
                                      "\n","                else:",
                                      "\n","                    for artifact in provisioningArtifacts:",
                                      "\n","                        if artifact['Name'] == version:",
                                      "\n","                            sc.delete_provisioning_artifact(ProductId=productID,ProvisioningArtifactId=artifact['Id'])",
                                      "\n","        ec2 = boto3.client('ec2',region)",
                                      "\n","        ec2.deregister_image(ImageId=amiID)",
                                      "\n","        time.sleep(5)",
                                      "\n","        snaps = ec2.describe_snapshots()",
                                      "\n","        for snap in snaps['Snapshots']:",
                                      "\n","            if amiID in snap['Description']:",
                                      "\n","                ec2.delete_snapshot(SnapshotId=snap['SnapshotId'])",
                                      "\n","        ssm = boto3.client('ssm',region)",
                                      "\n","        ssm.delete_parameters(Names=[prefix])",
                                      "\n","        temp =  ssm.get_parameter(Name=masterAmis)['Parameter']['Value']",
                                      "\n","        temp= temp.replace(amiID+',','').replace(','+amiID,'').replace(amiID,'')",
                                      "\n","        if len(temp) == 0:",
                                      "\n","            ssm.delete_parameters(Names=[masterAmis])",
                                      "\n","        else:",
                                      "\n","            ssm.put_parameter(Name=masterAmis,Type='String', Value=temp,Overwrite=True)",
                                      "\n","        if region == sourceRegion:",
                                      "\n","            ssm.delete_parameters(Names=params)",
                                      "\n","    return 'Done';"
                                  ]
                              ]
                          }
                      },
                      "Runtime": "python3.6",
                      "Timeout": 300,
                      "Handler": "index.lambda_handler",
                      "MemorySize": 512
                  }
              },

      "DecommissionAMIVersionFromAccountsLambda": {
                  "Type": "AWS::Lambda::Function",
                  "Properties": {
                      "Role": {
                          "Fn::GetAtt": [
                              "DecommissionAMIVersionLambdaRole",
                              "Arn"
                          ]
                      },
                      "Code": {
                          "ZipFile": {
                              "Fn::Join": [
                                  "",
                                  [
                                      "\n","import boto3",
                                      "\n","import json",
                                      "\n","from dateutil import parser",
                                      "\n","import dateutil",
                                      "\n","import datetime",
                                      "\n","import collections",
                                      "\n","import os",
                                      "\n","import time",
                                      "\n","import botocore",

                                      "\n","def lambda_handler(event, context):",
                                      "\n","    sourceRegion = os.environ['AWS_DEFAULT_REGION']",
                                      "\n","    s3 = boto3.resource('s3')",
                                      "\n","    prodName=event['productNameAndVersion']",
                                      "\n","    prodOS=event['productOSAndVersion']",
                                      "\n","    bucketName =event['bucketName']",
                                      "\n","    s3FilePrefix=event['templateFileName']",
                                      "\n","    version=event['versionToBeDeleted']",
                                      "\n","    masterAmis='/GoldenAMI/latest'",
                                      "\n","    amiRegionMappingParamName =event['amiRegionMappingParamName']",
                                      "\n","    prefix='/GoldenAMI/'+prodOS+'/'+prodName+'/'+version",
                                      "\n","    ssm = boto3.client('ssm',sourceRegion)",
                                      "\n","    SELF_ACCOUNT_ID = context.invoked_function_arn.split(':')[4]",
                                      "\n","    try:",
                                      "\n","        copyMetadata= ssm.get_parameter(Name=prefix+'/copyMetadata')['Parameter']['Value']",
                                      "\n","        jsonMetadata = json.loads(copyMetadata)",
                                      "\n","        for accountID, regions in jsonMetadata.items():",
                                      "\n","            if accountID != SELF_ACCOUNT_ID:",
                                      "\n","                roleArn ='arn:aws:iam::'+accountID+':role/",{"Ref":"roleName"},"' ",
                                      "\n","                regionList = regions.split(',')",
                                      "\n","                for region in regionList:",
                                      "\n","                    sts_client = boto3.client('sts')",
                                      "\n","                    roleOP=sts_client.assume_role(RoleArn=roleArn,RoleSessionName='ARS1')",
                                      "\n","                    creds = roleOP['Credentials']",
                                      "\n","                    ssm = boto3.client('ssm',region,aws_access_key_id = creds['AccessKeyId'],aws_secret_access_key = creds['SecretAccessKey'],aws_session_token = creds['SessionToken'])",
                                      "\n","                    amiID=ssm.get_parameter(Name=prefix)['Parameter']['Value']",
                                      "\n","                    temp =  ssm.get_parameter(Name=masterAmis)['Parameter']['Value']",
                                      "\n","                    temp= temp.replace(amiID+',','').replace(','+amiID,'').replace(amiID,'')",
                                      "\n","                    ssm.put_parameter(Name=masterAmis,Type='String', Value=temp,Overwrite=True)",
                                      "\n","                    ssm.delete_parameter(Name=prefix)",
                                      "\n","        ssm = boto3.client('ssm',sourceRegion)",
                                      "\n","        ssm.delete_parameters(Names=[amiRegionMappingParamName,prefix+'/copyMetadata'])",
                                      "\n","    except botocore.exceptions.ClientError as e:",
                                      "\n","        if e.response['Error']['Code'] == 'ParameterNotFound':",
                                      "\n","            print('AMI not shared.')",
                                      "\n","            ssm = boto3.client('ssm',sourceRegion)",
                                      "\n","            ssm.delete_parameter(Name=prefix)",
                                      "\n","    return 'Done';"
                                  ]
                              ]
                          }
                      },
                      "Runtime": "python3.6",
                      "Timeout": 300,
                      "Handler": "index.lambda_handler",
                      "MemorySize": 512
                  }
                  },

      "AppendParamLambdaRole": {
                  "Type": "AWS::IAM::Role",
                  "Properties": {
                      "ManagedPolicyArns": [
                          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                      ],
                      "AssumeRolePolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Principal": {
                                      "Service": [
                                          "lambda.amazonaws.com"
                                      ]
                                  },
                                  "Action": [
                                      "sts:AssumeRole"
                                  ]
                              }
                          ]
                      },
                      "Path": "/",
                      "Policies": [
                          {
                              "PolicyName": "AppendSsmParamLambdaPolicy",
                              "PolicyDocument": {
                                  "Version": "2012-10-17",
                                  "Statement": [
                                      {
                                          "Effect": "Allow",
                                          "Action": [
                                              "ssm:GetParameter*",
                                              "ssm:PutParameter*"
                                          ],
                                          "Resource": { "Fn::Join":
                                  [
                                      "",
                                      [
                                          "arn:aws:ssm:", "*",
                                          ":",
                                          {
                                              "Ref":"AWS::AccountId"
                                          },
                                          ":parameter/GoldenAMI/*"
                                      ]
                                  ]}
                                      }
                                  ]
                              }
                          }
                      ]
                  }
              },

      "AppendParamLambda": {
                  "Type": "AWS::Lambda::Function",
                  "Properties": {
                      "Role": {
                          "Fn::GetAtt": [
                              "AppendParamLambdaRole",
                              "Arn"
                          ]
                      },
                      "Code": {
                          "ZipFile": {
                              "Fn::Join": [
                                  "",
                                  [

                                      "\n","import json",
                                      "\n","import boto3",
                                      "\n","import botocore",
                                      "\n","def lambda_handler(event, context):",
                                      "\n","    paramName =event['parameterName'];",
                                      "\n","    amiIDVal=event['valueToBeCreatedOrAppended']",
                                      "\n","    print(amiIDVal)",
                                      "\n","    amiID=amiIDVal.replace(\"",  "\\\\r\\\\n",    "\",\"\\n\")",
                                      "\n","    print(amiID)",
                                      "\n","    ssm = boto3.client('ssm')",
                                      "\n","    try:",
                                      "\n","        AMIIdsParam =ssm.get_parameter(Name=paramName)",
                                      "\n","        AMIIds=AMIIdsParam['Parameter']['Value']",
                                      "\n","        AMIIds= AMIIds+','+ amiID",
                                      "\n","        ssm.put_parameter(Name=paramName,Type='String', Value=AMIIds,Overwrite=True)",
                                      "\n","    except botocore.exceptions.ClientError as e:",
                                      "\n","        if e.response['Error']['Code'] == 'ParameterNotFound':",
                                      "\n","            ssm.put_parameter(Name=paramName,Type='String', Value=amiID,Overwrite=True)",
                                      "\n","    return 'appended parameter %s with value %s.' % (paramName,amiID)"
                                  ]
                              ]
                          }
                      },
                      "Runtime": "python3.6",
                      "Timeout": 300,
                      "Handler": "index.lambda_handler",
                      "MemorySize": 512
                  }
              },

      "StoreVersionLambdaFunction": {
                  "Type": "AWS::Lambda::Function",
                  "Properties": {
                      "Role": {
                          "Fn::GetAtt": [
                              "AppendParamLambdaRole",
                              "Arn"
                          ]
                      },
                      "Code": {
                          "ZipFile": {
                              "Fn::Join": [
                                  "\n",
                                  [
                                      "import json",
                                      "import urllib.parse",
                                      "import boto3",
                                      "import time",
                                      "import os",
                                      "def lambda_handler(event, context):",
                                      "    amiId = event['AMI-ID']",
                                      "    instanceId = event['instanceId']",
                                      "    productOS = event.get('productOS')",
                                      "    productName = event.get('productName')",
                                      "    productVersion = event.get('productVersion')",
                                      "    topicArn=event['topicArn']",
                                      "    fullName = amiId+'-'+productOS+'/'+productName+'/'+productVersion",
                                      "    region = os.environ[\"AWS_DEFAULT_REGION\"]",
                                      "    ",
                                      "    assessmentTemplateArn=\"\";",
                                      "    ",
                                      "    ec2Source =boto3.resource('ec2',region)",
                                      "    ssm = boto3.client('ssm',region) ",
                                      "    ParamName='/GoldenAMI/'+productOS+'/'+productName+'/'+productVersion+'/latestInstance'",
                                      "    ssm.put_parameter(Name=ParamName,Value=instanceId,Type='String',Overwrite=True) ",
                                      "    time.sleep(10)",
                                      "    return \"Done\""
                                  ]
                              ]
                          }
                      },
                      "Runtime": "python3.6",
                      "Timeout": 300,
                      "Handler": "index.lambda_handler",
                      "MemorySize": 512
                  }
              },

      "ApproverTopicPolicy": {
                  "Type": "AWS::SNS::TopicPolicy",
                  "Properties": {
                      "PolicyDocument": {
                          "Id": "ApproverTopicPolicy",
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Sid": "ApproverTopicPolicySID",
                                  "Effect": "Allow",
                                  "Principal": {
                                      "AWS": [
                                          {
                                              "Fn::GetAtt": [
                                                  "AutomationServiceRole",
                                                  "Arn"
                                              ]
                                          }
                                      ]
                                  },
                                  "Action": "sns:Publish",
                                  "Resource": {
                              "Ref": "ApproverNotification"
                          }
                              }
                          ]
                      },
                      "Topics": [
                          {
                              "Ref": "ApproverNotification"
                          }
                      ]
                  }
              },

      "ApproverNotification": {
                  "Type": "AWS::SNS::Topic"
              },

      "ApproverNotificationSubscription" : {
                "Type" : "AWS::SNS::Subscription",
                "Properties" : {
                  "Endpoint" : {"Ref":"EmailID"},
                  "Protocol" : "email",
                  "TopicArn" : {"Ref" : "ApproverNotification"}
                }
              },

      "ManagedInstanceRole": {
                  "Type": "AWS::IAM::Role",
                  "Properties": {
                      "AssumeRolePolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Principal": {
                                      "Service": [
                                          "ssm.amazonaws.com",
                                          "ec2.amazonaws.com"
                                      ]
                                  },

                                  "Action": "sts:AssumeRole"
                              }
                          ]
                      },
                      "ManagedPolicyArns": [
                          "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM",
                          "arn:aws:iam::aws:policy/AmazonEC2FullAccess"
                      ],
                      "Path": "/",
                      "Policies": [
                          {
                              "PolicyName": "SamplePolicy",
                              "PolicyDocument": {
                                  "Version": "2012-10-17",
                                  "Statement": {
                                      "Action": [
                                          "s3:*"
                                      ],
                                      "Effect": "Allow",
                                      "Resource": [
                                          {
                                              "Fn::Join": [
                                                  "",
                                                  [
                                                      "arn:aws:s3:::",
                                                      {
                                                          "Ref": "GoldenAMIConfigBucket"
                                                      }
                                                  ]
                                              ]
                                          },
                                          {
                                              "Fn::Join": [
                                                  "",
                                                  [
                                                      "arn:aws:s3:::",
                                                      {
                                                          "Ref": "GoldenAMIConfigBucket"
                                                      },
                                                      "/*"
                                                  ]
                                              ]
                                          }
                                      ]
                                  }
                              }
                          }
                      ]
                  }
              },

      "ManagedInstanceProfile": {
                  "Type": "AWS::IAM::InstanceProfile",
                  "Properties": {
                      "Path": "/",
                      "Roles": [
                          {
                              "Ref": "ManagedInstanceRole"
                          }
                      ]
                  }
              },

      "AutomationServiceRole": {
                  "Type": "AWS::IAM::Role",
                  "Properties": {
                      "AssumeRolePolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Principal": {
                                      "Service": [
                                          "ssm.amazonaws.com",
                                          "ec2.amazonaws.com"
                                      ]
                                  },
                                  "Action": "sts:AssumeRole"
                              }
                          ]
                      },
                      "ManagedPolicyArns": [
                          "arn:aws:iam::aws:policy/service-role/AmazonSSMAutomationRole"
                      ],
                      "Path": "/",
                      "Policies": [
                          {
                              "PolicyName": "passrole",
                              "PolicyDocument": {
                                  "Version": "2012-10-17",
                                  "Statement": [
                                      {
                                          "Effect": "Allow",
                                          "Action": [
                                              "iam:PassRole"
                                          ],
                                          "Resource": [
                                              {
                                                  "Fn::GetAtt": [
                                                      "ManagedInstanceRole",
                                                      "Arn"
                                                  ]
                                              }
                                          ]
                                      }
                                  ]
                              }
                          },
                          {
                              "PolicyName": "invokeLambdaFunction",
                              "PolicyDocument": {
                                  "Version": "2012-10-17",
                                  "Statement": [
                                      {
                                          "Effect": "Allow",
                                          "Action": "lambda:InvokeFunction",
                                          "Resource": [
                                             {
                                                  "Fn::GetAtt": [
                                                      "StoreVersionLambdaFunction",
                                                      "Arn"
                                                  ]
                                              },
                                             { "Fn::GetAtt": [ "AppendParamLambda","Arn"]},
                                          { "Fn::GetAtt": [ "CopyToMultipleRegionsLambdaFunction" ,"Arn"]},{ "Fn::GetAtt": [ "CopyToMultipleAccountsLambdaFunction","Arn"] },
                                          { "Fn::GetAtt": ["PublishAMILambda","Arn"] },{ "Fn::GetAtt": ["DecommissionAMIVersionLambda","Arn"]},
                                          { "Fn::GetAtt": [ "DecommissionAMIVersionFromAccountsLambda","Arn"]}]
                                      }
                                  ]
                              }
                          }
                      ]
                  }
              },

      "LinuxGoldenAMIAutomationDoc": {
                  "Type": "AWS::SSM::Document",
                  "Properties": {
                      "DocumentType": "Automation",
                      "Content": {
                          "description": "This automation document triggers Golden AMI creation workflow. And also updates AMI with Linux distribution packages and Amazon software",
                          "schemaVersion": "0.3",
                          "assumeRole": {
                              "Fn::GetAtt": [
                                  "AutomationServiceRole",
                                  "Arn"
                              ]
                          },
                          "parameters": {
                              "sourceAMIid": {
                                  "type": "String",
                                  "description": "Source/Base AMI to be used for generating your golden AMI",
                                  "default": "<ENTER AMI ID>"
                              },

                              "tenableApiKey": {
                                "default": "/GoldenAMI/tenable/tenableApiKey",
                                "description": "SSM parameter name of tenable API Key to access API",
                                "type": "String"
                              },

                              "tenableSecretKey": {
                                "default": "/GoldenAMI/tenable/tenableSecretKey",
                                "description": "SSM parameter name of the tenable API Secret Key to access API",
                                "type": "String"
                              },

                              "tenableScannerName": {
                                "default": "{{ssm:/GoldenAMI/tenable/tenableScannerName}}",
                                "description": "Scanner name for launching tenable VM Scan",
                                "type": "String"
                              },

                              "tenableScanType": {
                                "default": "{{ssm:/GoldenAMI/tenable/tenableScanType}}",
                                "description": "SCAN TYPE for launching tenable VM Scan",
                                "type": "String"
                              },

                              "tenableApiUrl": {
                                "type": "String",
                                "description": "Your tenable URL for accessing API",
                                "default": {
                                    "Ref": "tenableApiUrl"
                                  }
                              },

                              "productName": {
                                  "type": "String",
                                  "description": "The syntax of this parameter is ProductName-ProductVersion.",
                                  "default": {
                                      "Ref": "productName"
                                }
                              },

                              "productOSAndVersion": {
                                  "type": "String",
                                  "description": "The syntax of this parameter is OSName-OSVersion",
                                  "default": {
                                      "Ref": "productOSAndVersion"
                                  }
                                },

                              "AMIVersion": {
                                  "type": "String",
                                  "description": "Golden AMI Build version number to be created.",
                                  "default": {
                                      "Ref": "buildVersion"
                                  }
                                },

                              "subnetId": {
                                  "type": "String",
                                  "default":{
                                      "Ref": "subnetPublic"
                                  },
                                  "description": "Subnet in which instances will be launched."
                              },
                              
                              "privatesubnetId": {
                                  "type": "String",
                                  "default":{
                                      "Ref": "subnetPrivate"
                                  },
                                  "description": "Subnet in which instances will be launched."
                              },

                              "securityGroupId": {
                                  "type": "String",
                                  "default":{
                                      "Ref": "secGroup"
                                  },
                                  "description": "Security Group that will be attached to the instance. By Default a security group without any inbound access is attached"
                              },

                              "instanceType": {
                                  "type": "String",
                                  "description": "A compatible instance-type for launching an instance",
                                  "default": {
                                      "Ref": "instanceType"
                                  }
                              },

                              "targetAMIname": {
                                  "type": "String",
                                  "description": "Name for the golden AMI to be created",
                                  "default": "{{productName}}-{{productOSAndVersion}}-{{AMIVersion}}"
                                },

                              "ApproverUserIAMARN1": {
                                  "type": "String",
                                  "description": "IAM ARN of the user who has SSM approval permissions.",
                                  "default": {
                                      "Ref": "ApproverUserIAMARN1"
                                  }
                                },
                              "ApproverUserIAMARN2": {
                                  "type": "String",
                                  "description": "IAM ARN of the user who has SSM approval permissions.",
                                  "default": {
                                      "Ref": "ApproverUserIAMARN2"
                                  }
                                },

                              "ApproverUserIAMARN3": {
                                  "type": "String",
                                  "description": "IAM ARN of the user who has SSM approval permissions.",
                                  "default": {
                                      "Ref": "ApproverUserIAMARN3"
                                  }
                                },

                              "ApproverNotificationArn": {
                                  "type": "String",
                                  "description": "SNS Topic ARN on which a notification would be published once the golden AMI candidate is ready for validation.",
                                  "default": {
                                      "Ref": "ApproverNotification"
                                  }
                              },

                              "ManagedInstanceProfile": {
                                  "type": "String",
                                  "description": "Instance Profile. Do not change the default value.",
                                  "default": {
                                      "Ref": "ManagedInstanceProfile"
                                  }
                              },

                              "EmailID": {
                                "type": "String",
                                "description": "Email ID of the admin who will receive scan assessment reports from Tenable",
                                "default": {
                                    "Ref": "EmailID"
                                }
                              },

                              "SSMInstallationUserData": {
                                  "type": "String",
                                  "description": "Base64 encoded SSM installation user-data.",
                                  "default": "IyEvYmluL2Jhc2gKCmZ1bmN0aW9uIGdldF9jb250ZW50cygpIHsKICAgIGlmIFsgLXggIiQod2hpY2ggY3VybCkiIF07IHRoZW4KICAgICAgICBjdXJsIC1zIC1mICIkMSIKICAgIGVsaWYgWyAteCAiJCh3aGljaCB3Z2V0KSIgXTsgdGhlbgogICAgICAgIHdnZXQgIiQxIiAtTyAtCiAgICBlbHNlCiAgICAgICAgZGllICJObyBkb3dubG9hZCB1dGlsaXR5IChjdXJsLCB3Z2V0KSIKICAgIGZpCn0KCnJlYWRvbmx5IFRPS0VOX1VSTD0iaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvYXBpL3Rva2VuIgpmdW5jdGlvbiBnZXRfY29udGVudHNfSU1EU3YyKCkgewogICAgaWYgWyAteCAiJCh3aGljaCBjdXJsKSIgXTsgdGhlbgogICAgICAgIHJlYWRvbmx5IFRPS0VOPSQoY3VybCAtcyAtZiAtWCBQVVQgLUggIlgtYXdzLWVjMi1tZXRhZGF0YS10b2tlbi10dGwtc2Vjb25kczogMjE2MDAiICIkVE9LRU5fVVJMIikKICAgICAgICBjdXJsIC1zIC1mIC1IICJYLWF3cy1lYzItbWV0YWRhdGEtdG9rZW46ICRUT0tFTiIgIiQxIgogICAgZWxpZiBbIC14ICIkKHdoaWNoIHdnZXQpIiBdOyB0aGVuCiAgICAgICAgIyB3Z2V0IGRvZXNuJ3Qgc3VwcG9ydCAtLW1ldGhvZCBmbGFnIGluIG1hbnkgY2FzZXMsIHNvIGZhbGwgYmFjayBvbiBJTURTdjEKICAgICAgICB3Z2V0ICIkMSIgLU8gLQogICAgZWxzZQogICAgICAgIGRpZSAiTm8gZG93bmxvYWQgdXRpbGl0eSAoY3VybCwgd2dldCkiCiAgICBmaQp9CgpyZWFkb25seSBJREVOVElUWV9VUkw9Imh0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvMjAxNi0wNi0zMC9keW5hbWljL2luc3RhbmNlLWlkZW50aXR5L2RvY3VtZW50LyIKcmVhZG9ubHkgVFJVRV9SRUdJT049JChnZXRfY29udGVudHNfSU1EU3YyICIkSURFTlRJVFlfVVJMIiB8IGF3ayAtRlwiICcvcmVnaW9uLyB7IHByaW50ICQ0IH0nKQpyZWFkb25seSBERUZBVUxUX1JFR0lPTj0idXMtZWFzdC0xIgpyZWFkb25seSBSRUdJT049IiR7VFJVRV9SRUdJT046LSRERUZBVUxUX1JFR0lPTn0iCgpmdW5jdGlvbiBkaWUoKSB7CiAgICBlY2hvICIkQCwgZXhpdGluZy4iID4mMgogICAgZXhpdCAxCn0KCmZ1bmN0aW9uIGlzc3VlX21hdGNoKCkgewogICAgZ3JlcCAtRSAtaSAtYyAiJDEiIC9ldGMvaXNzdWUgMj4mMSAmPi9kZXYvbnVsbAogICAgWyAkPyAtZXEgMCBdICYmIGVjaG8gInRydWUiIHx8IGVjaG8gImZhbHNlIgp9CgpmdW5jdGlvbiBpc19kZWJ1bnR1KCkgewogICAgZWNobyAiJChpc3N1ZV9tYXRjaCAnRGViaWFufFVidW50dScpIgp9CgpmdW5jdGlvbiBpc19yZWRoYXQoKSB7CiAgICBpZiBbIC1mICIvZXRjL3N5c3RlbS1yZWxlYXNlIiBdIHx8CiAgICAgICAgWyAtZiAiL2V0Yy9yZWRoYXQtcmVsZWFzZSIgXTsgdGhlbgogICAgICAgIGVjaG8gInRydWUiCiAgICBlbHNlCiAgICAgICAgZWNobyAiZmFsc2UiCiAgICBmaQp9CgpmdW5jdGlvbiBpc19zdXNlKCkgewogICAgaWYgWyAtZiAiL2V0Yy9vcy1yZWxlYXNlIiBdOyB0aGVuCiAgICAgICAgeD0kKGdyZXAgLUUgLWkgLWMgInN1c2UiIC9ldGMvb3MtcmVsZWFzZSAyPi9kZXYvbnVsbCkKICAgICAgICBpZiBbICR4IC1ndCAwIF07IHRoZW4KICAgICAgICAgICAgZWNobyAidHJ1ZSIKICAgICAgICBlbHNlCiAgICAgICAgICAgIGVjaG8gImZhbHNlIgogICAgICAgIGZpCiAgICBlbHNlCiAgICAgICAgZWNobyAiZmFsc2UiCiAgICBmaQp9CgpmdW5jdGlvbiBnZXRfYXJjaCgpIHsKICAgIGlmIFsgIiQodW5hbWUgLW0pIiA9PSAieDg2XzY0IiBdOyB0aGVuCiAgICAgICAgZWNobyAiYW1kNjQiCiAgICBlbGlmIFtbICIkKHVuYW1lIC1tKSIgPX4gaVszLTZdODYgXV07IHRoZW4KICAgICAgICBlY2hvICIzODYiCiAgICBlbHNlCiAgICAgICAgZGllICJVbnN1cHBvcnRlZCBhcmNoaXRlY3R1cmUgJCh1bmFtZSAtbSkiCiAgICBmaQp9CgpmdW5jdGlvbiBnZXRfcGFja2FnZV90eXBlKCkgewogICAgaWYgWyAiJChpc19kZWJ1bnR1KSIgPT0gInRydWUiIF07IHRoZW4KICAgICAgICBlY2hvICJkZWIiCiAgICBlbGlmIFsgIiQoaXNfcmVkaGF0KSIgPT0gInRydWUiIF07IHRoZW4KICAgICAgICBlY2hvICJycG0iCiAgICBlbGlmIFsgIiQoaXNfc3VzZSkiID09ICJ0cnVlIiBdOyB0aGVuCiAgICAgICAgZWNobyAicnBtIgogICAgZmkKfQoKCmZ1bmN0aW9uIGdldF9kaXN0KCkgewogICAgaWYgWyAiJChpc19kZWJ1bnR1KSIgPT0gInRydWUiIF07IHRoZW4KICAgICAgICBlY2hvICJkZWJpYW4iCiAgICBlbGlmIFsgIiQoaXNfcmVkaGF0KSIgPT0gInRydWUiIF07IHRoZW4KICAgICAgICBlY2hvICJsaW51eCIKICAgIGVsaWYgW1sgIiQoaXNfc3VzZSkiID09ICJ0cnVlIiBdXTsgdGhlbgogICAgICAgIGVjaG8gImxpbnV4IgogICAgZWxzZQogICAgICAgIGRpZSAiVW5rbm93biBkaXN0cmlidXRpb24iCiAgICBmaQp9CgpmdW5jdGlvbiBnZXRfc3NtX2FnZW50KCkgewogICAgZWNobyAiRmV0Y2hpbmcgU1NNIEFnZW50Li4uIgogICAgZXh0ZW5zaW9uPSIkKGdldF9wYWNrYWdlX3R5cGUpIgogICAgZGlzdD0iJChnZXRfZGlzdCkiCiAgICBhcmNoPSIkKGdldF9hcmNoKSIKCiAgICBwYWNrYWdlPSJhbWF6b24tc3NtLWFnZW50LiRleHRlbnNpb24iCiAgICB1cmxfYmFzZT0iaHR0cHM6Ly9hbWF6b24tc3NtLSRSRUdJT04uczMuYW1hem9uYXdzLmNvbSIKICAgIHVybD0iJHt1cmxfYmFzZX0vbGF0ZXN0LyR7ZGlzdH1fJHthcmNofS8ke3BhY2thZ2V9IgogICAgRklMRV9TSVpFPTAKCiAgICB3aGlsZSBbICRSRVRSWV9DT1VOVCAtbHQgJE1BWF9SRVRSWV9DT1VOVCBdIDsgZG8KICAgICAgZ2V0X2NvbnRlbnRzICIkdXJsIiA+ICIkcGFja2FnZSIKCiAgICAgIGlmIFsgLWYgIiRwYWNrYWdlIiBdOyB0aGVuCiAgICAgICAgRklMRV9TSVpFPSQoZHUgLWsgJHBhY2thZ2UgfCBjdXQgLWYxKQogICAgICAgIGlmIFsgJEZJTEVfU0laRSAtZ3QgMCBdOyB0aGVuCiAgICAgICAgICBicmVhawogICAgICAgIGZpCiAgICAgIGZpCiAgICAgIFJFVFJZX0NPVU5UPSQoKFJFVFJZX0NPVU5UKzEpKTsKICAgICAgZWNobyBBd3MtSW5zdGFsbC1Tc20tQWdlbnQ6IFJldHJ5aW5nIGRvd25sb2FkIHJldHJ5Q291bnQ6ICRSRVRSWV9DT1VOVCwgZmlsZVNpemU6ICRGSUxFX1NJWkUgdXJsOiR1cmwgcGFja2FnZTokcGFja2FnZQogICAgZG9uZQoKICAgIGlmIFsgISAtZiAiJHBhY2thZ2UiIF0gfHwgWyAkRklMRV9TSVpFIC1lcSAwIF07IHRoZW4KICAgICAgICBkaWUgIkNvdWxkIG5vdCBkb3dubG9hZCB0aGUgcGFja2FnZSBmcm9tICR1cmwgYWZ0ZXIgJFJFVFJZX0NPVU5UIHJldHJpZXMiCiAgICBmaQp9CgpmdW5jdGlvbiBzdGFydF9zc21fYWdlbnQoKSB7CiAgICBlY2hvICJTdGFydGluZyBTU00gQWdlbnQuLi4iCiAgICBpZiBbIC14ICIkKHdoaWNoIHN5c3RlbWN0bCkiIF07IHRoZW4KICAgICAgICAgIHN5c3RlbWN0bCBzdGFydCBhbWF6b24tc3NtLWFnZW50CiAgICBlbGlmIFsgLXggIiQod2hpY2ggc3RhcnQpIiBdOyB0aGVuCiAgICAgICAgICBzdGFydCBhbWF6b24tc3NtLWFnZW50CiAgICBlbHNlCiAgICAgICAgICBlY2hvICJDb3VsZCBub3QgZmluZCBjb21tYW5kIHRvIHN0YXJ0IFNTTSBBZ2VudC4gU2tpcHBpbmcgQWdlbnQgc3RhcnQuIgogICAgZmkKfQoKZnVuY3Rpb24gaW5zdGFsbF9zc21fYWdlbnQoKSB7CiAgICBlY2hvICJJbnN0YWxsaW5nIFNTTSBBZ2VudC4uLiIKICAgIHdoaWxlIFsgJFJFVFJZX0NPVU5UIC1sdCAkTUFYX1JFVFJZX0NPVU5UIF0gOyBkbwogICAgICBpZiBbICIkKGlzX2RlYnVudHUpIiA9PSAidHJ1ZSIgXTsgdGhlbgogICAgICAgICMgSWYgYW4gZXhpc3RpbmcgdmVyc2lvbiBpcyBpbnN0YWxsZWQgd2l0aCBzbmFwLCBpdCB3aWxsIGJsb2NrIHVwZ3JhZGUuCiAgICAgICAgc25hcCByZW1vdmUgYW1hem9uLXNzbS1hZ2VudAogICAgICAgIGRwa2cgLWkgYW1hem9uLXNzbS1hZ2VudC5kZWIKICAgICAgZWxpZiBbICIkKGlzX3JlZGhhdCkiID09ICJ0cnVlIiBdOyB0aGVuCiAgICAgICAgeXVtIGluc3RhbGwgLS1ub2dwZ2NoZWNrIC15IGFtYXpvbi1zc20tYWdlbnQucnBtCiAgICAgIGVsaWYgWyAiJChpc19zdXNlKSIgPT0gInRydWUiIF07IHRoZW4KICAgICAgICBycG0gLS1pbnN0YWxsIGFtYXpvbi1zc20tYWdlbnQucnBtCiAgICAgIGVsc2UKICAgICAgICBkaWUgIlVua25vd24gZGlzdHJpYnV0aW9uIgogICAgICBmaQoKICAgICAgaWYgWyAteCAiJCh3aGljaCBhbWF6b24tc3NtLWFnZW50KSIgXTsgdGhlbgogICAgICAgIGJyZWFrCiAgICAgIGZpCiAgICAgIFJFVFJZX0NPVU5UPSQoKFJFVFJZX0NPVU5UKzEpKTsKICAgICAgZWNobyBBd3MtSW5zdGFsbC1Tc20tQWdlbnQ6IFJldHJ5aW5nIGluc3RhbGxhdGlvbiByZXRyeUNvdW50OiAkUkVUUllfQ09VTlQKICAgIGRvbmUKCiAgICBpZiBbICEgLXggIiQod2hpY2ggYW1hem9uLXNzbS1hZ2VudCkiIF07IHRoZW4KICAgICAgZGllICJObyBTU00gYWdlbnQgd2FzIGluc3RhbGxlZCIKICAgIGZpCn0KCmZ1bmN0aW9uIG1haW4oKSB7CiAgICBNQVhfUkVUUllfQ09VTlQ9MwogICAgUkVUUllfQ09VTlQ9MAoKICAgIGNkIC90bXAKCiAgICB3aGlsZSBbICRSRVRSWV9DT1VOVCAtbHQgJE1BWF9SRVRSWV9DT1VOVCBdIDsgZG8KICAgICAgZ2V0X3NzbV9hZ2VudAogICAgICBpbnN0YWxsX3NzbV9hZ2VudAoKICAgICAgaWYgWyAhIC14ICIkKHdoaWNoIGFtYXpvbi1zc20tYWdlbnQpIiBdOyB0aGVuCiAgICAgICAgUkVUUllfQ09VTlQ9JCgoUkVUUllfQ09VTlQrMSkpOwogICAgICAgIGVjaG8gU1NNQWdlbnQgSW5zdGFsbGF0aW9uIGZhaWxlZCAkUkVUUllfQ09VTlQgdGltZXMsIHJldHJ5aW5nLi4uCiAgICAgICAgY29udGludWUKICAgICAgZWxzZQogICAgICAgIHN0YXJ0X3NzbV9hZ2VudAogICAgICAgIGV4aXQgMAogICAgICBmaQoKICAgIGRvbmUKfQoKbWFpbiAkQCAyPiYxIHwgdGVlIC90bXAvYXdzLWluc3RhbGwtc3NtLWFnZW50LmxvZwo="
                                },

                              "PreUpdateScript": {
                                  "type": "String",
                                  "description": "(Optional) URL of a script to run before updates are applied. Default (\"none\") is to not run a script.",
                                  "default": "none"
                              },

                              "PostUpdateScript": {
                                  "type": "String",
                                  "description": "(Optional) URL of a script to run after package updates are applied. Default (\"none\") is to not run a script.",
                                  "default": "none"
                              },

                              "IncludePackages": {
                                  "type": "String",
                                  "description": "(Optional) Only update these named packages. By default (\"all\"), all available updates are applied.",
                                  "default": "all"
                              },

                              "ExcludePackages": {
                                  "type": "String",
                                  "description": "(Optional) Names of packages to hold back from updates, under all conditions. By default (\"none\"), no package is excluded.",
                                  "default": "none"
                              }

                          },
                          "mainSteps": [
                              {
                                  "name": "startInstances",
                                  "action": "aws:runInstances",
                                  "timeoutSeconds": 3600,
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "ImageId": "{{ sourceAMIid }}",
                                      "InstanceType": "{{instanceType}}",
                                      "MinInstanceCount": 1,
                                      "MaxInstanceCount": 1,
                                      "SubnetId": "{{ privatesubnetId }}",
                                      "SecurityGroupIds": [
                                          "{{ securityGroupId }}"
                                      ],
                                      "UserData": "{{SSMInstallationUserData}}",
                                      "IamInstanceProfileName": "{{ ManagedInstanceProfile }}"
                                  }
                              },
                              {
                                "name": "verifySsmInstall",
                                "action": "aws:runCommand",
                                "maxAttempts": 3,
                                "timeoutSeconds": 1200,
                                "onFailure": "Abort",
                                "inputs": {
                                  "DocumentName": "AWS-RunShellScript",
                                  "InstanceIds": [
                                    "{{startInstances.InstanceIds}}"
                                  ],
                                  "Parameters": {
                                    "commands": [
                                      "hostname"
                                    ]
                                  }
                                }
                              },
                              {
                                  "name": "updateOSSoftware",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "timeoutSeconds": 3600,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "DocumentName": "AWS-RunShellScript",
                                      "InstanceIds": [
                                          "{{startInstances.InstanceIds}}"
                                      ],
                                      "Parameters": {
                                          "commands": [
                                            "#!/bin/bash",
                                            "",
                                            "set -e",
                                            "",
                                            "function unhold_deb_packages() {",
                                            "    for package in $EXCLUDE_PACKAGES; do",
                                            "        apt-mark unhold $package",
                                            "    done",
                                            "}",
                                            "function removelock_zypper_packages() {",
                                            "    for package in $EXCLUDE_PACKAGES; do",
                                            "        zypper removelock $package",
                                            "    done",
                                            "}",
                                            "",
                                            "function die() {",
                                            "    if [ \"$(get_dist)\" == \"debian\" ]; then",
                                            "        unhold_deb_packages",
                                            "    elif [ \"$(get_dist)\" == \"suse\" ]; then",
                                            "        removelock_zypper_packages",
                                            "    fi",
                                            "",
                                            "    echo \"$@\" >&2",
                                            "    exit 1",
                                            "}",
                                            "",
                                            "function get_contents() {",
                                            "    if [ -x \"$(which curl)\" ]; then",
                                            "        curl -s -f \"$1\"",
                                            "    elif [ -x \"$(which wget)\" ]; then",
                                            "        wget \"$1\" -O -",
                                            "    else",
                                            "        die \"No download utility (curl, wget)\"",
                                            "    fi",
                                            "}",
                                            "",
                                            "function sanitize_inputs() {",
                                            "    value=\"$(echo $@ | sed 's/,/ /g' | xargs | xargs)\"",
                                            "",
                                            "    if [ ! -z \"$value\" ] &&",
                                            "        [ \"$value\" != \"none\" ] &&",
                                            "        [ \"$value\" != \"all\" ]; then",
                                            "        echo \"$value\"",
                                            "    fi",
                                            "}",
                                            "",
                                            "function echo_options() {",
                                            "    echo \\\"\\$PRE_UPDATE_SCRIPT_URL\\\" == \\\"$PRE_UPDATE_SCRIPT_URL\\\"",
                                            "    echo \\\"\\$POST_UPDATE_SCRIPT_URL\\\" == \\\"$POST_UPDATE_SCRIPT_URL\\\"",
                                            "    echo \\\"\\$INCLUDE_PACKAGES\\\" == \\\"$INCLUDE_PACKAGES\\\"",
                                            "    echo \\\"\\$EXCLUDE_PACKAGES\\\" == \\\"$EXCLUDE_PACKAGES\\\"",
                                            "}",
                                            "",
                                            "function exec_cmd() {",
                                            "    echo \"Invoking $@...\"",
                                            "    eval \"$@\"",
                                            "",
                                            "    if [ $? -ne 0 ]; then",
                                            "        die \"\"",
                                            "    fi",
                                            "}",
                                            "",
                                            "function is_debuntu() {",
                                            "    grep -E -i -c 'Debian|Ubuntu' /etc/issue 2>&1 &>/dev/null",
                                            "    [ $? -eq 0 ] && echo \"true\" || echo \"false\"",
                                            "}",
                                            "",
                                            "function is_redhat() {",
                                            "    if [ -f \"/etc/system-release\" ] ||",
                                            "        [ -f \"/etc/redhat-release\" ]; then",
                                            "        echo \"true\"",
                                            "    else",
                                            "        echo \"false\"",
                                            "    fi",
                                            "}",
                                            "",
                                            "function is_suse() {",
                                            "    if type zypper > /dev/null; then",
                                            "        echo \"true\"",
                                            "    else",
                                            "        echo \"false\"",
                                            "    fi",
                                            "}",
                                            "",
                                            "function get_dist() {",
                                            "    if [ \"$(is_debuntu)\" == \"true\" ]; then",
                                            "        echo \"debian\"",
                                            "    elif [ \"$(is_redhat)\" == \"true\" ]; then",
                                            "        echo \"redhat\"",
                                            "    elif [ \"$(is_suse)\" == \"true\" ]; then",
                                            "        echo \"suse\"",
                                            "    else",
                                            "        die \"Unknown distribution\"",
                                            "    fi",
                                            "}",
                                            "",
                                            "function run_hook_script() {",
                                            "    script_url=\"$1\"",
                                            "    tmp_file=\"$(mktemp)\"",
                                            "",
                                            "    echo \"Downloading hook script from $script_url\"",
                                            "",
                                            "    get_contents \"$script_url\" > \"$tmp_file\"",
                                            "    chmod +x \"$tmp_file\"",
                                            "",
                                            "    exec_cmd \"$tmp_file\"",
                                            "}",
                                            "",
                                            "function update_cli() {",
                                            "    if [ -x \"$(which pip 2>/dev/null)\" ]; then",
                                            "        exec_cmd \"pip install --upgrade awscli\"",
                                            "    fi",
                                            "}",
                                            "",
                                            "function apt_get_update() {",
                                            "",
                                            "    dpkg_flags=\"-o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold\"",
                                            "    apt_noninteractive_cmd=\"DEBIAN_FRONTEND=noninteractive apt-get $dpkg_flags\"",
                                            "",
                                            "    exec_cmd \"apt-get clean\"",
                                            "    exec_cmd \"apt-get update\"",
                                            "",
                                            "    for package in $EXCLUDE_PACKAGES; do",
                                            "        exec_cmd \"apt-mark hold $package\"",
                                            "    done",
                                            "",
                                            "    if [ -z \"$INCLUDE_PACKAGES\" ]; then",
                                            "        exec_cmd \"$apt_noninteractive_cmd -y dist-upgrade\"",
                                            "    else",
                                            "        for package in $INCLUDE_PACKAGES; do",
                                            "            exec_cmd \"$apt_noninteractive_cmd -y install --only-upgrade $package\"",
                                            "        done",
                                            "    fi",
                                            "",
                                            "    unhold_deb_packages",
                                            "}",
                                            "",
                                            "function yum_upgrade() {",
                                            "    exec_cmd 'yum clean all'",
                                            "",
                                            "    yum_cmd='yum -y upgrade'",
                                            "",
                                            "    for package in $EXCLUDE_PACKAGES; do",
                                            "        yum_cmd=\"$yum_cmd -x $package\"",
                                            "    done",
                                            "",
                                            "    if [ ! -z \"$INCLUDE_PACKAGES\" ]; then",
                                            "        yum_cmd=\"$yum_cmd $INCLUDE_PACKAGES\"",
                                            "    fi",
                                            "",
                                            "    exec_cmd \"$yum_cmd\"",
                                            "}",
                                            "function zypper_upgrade() {",
                                            "    exec_cmd 'zypper clean'",
                                            "    zypper_cmd='zypper update -y'",
                                            "    for package in $EXCLUDE_PACKAGES; do",
                                            "        exec_cmd \"zypper addlock $package\"",
                                            "    done",
                                            "",
                                            "    if [ ! -z \"$INCLUDE_PACKAGES\" ]; then",
                                            "        zypper_cmd=\"$zypper_cmd $INCLUDE_PACKAGES\"",
                                            "    fi",
                                            "",
                                            "    exec_cmd \"$zypper_cmd\"",
                                            "",
                                            "    removelock_zypper_packages",
                                            "}",
                                            "",
                                            "function remove_excludes_from_includes() {",
                                            "    if [ -z \"$EXCLUDE_PACKAGES\" ] || [ -z \"$INCLUDE_PACKAGES\" ]; then",
                                            "        return",
                                            "    fi",
                                            "",
                                            "    declare -A includes",
                                            "    declare -A excludes",
                                            "",
                                            "    for package in $EXCLUDE_PACKAGES; do",
                                            "        excludes[$package]=\"true\"",
                                            "    done",
                                            "",
                                            "    for package in $INCLUDE_PACKAGES; do",
                                            "        if [ \"${excludes[$package]}\" != \"true\" ]; then",
                                            "            includes[$package]=\"true\"",
                                            "        fi",
                                            "    done",
                                            "",
                                            "    INCLUDE_PACKAGES=\"${!includes[@]}\"",
                                            "}",
                                            "",
                                            "function update_packages() {",
                                            "    remove_excludes_from_includes",
                                            "",
                                            "    if [ \"$(get_dist)\" == \"debian\" ]; then",
                                            "        apt_get_update",
                                            "    elif [ \"$(get_dist)\" == \"redhat\" ]; then",
                                            "        yum_upgrade",
                                            "    else ",
                                            "        zypper_upgrade",
                                            "    fi",
                                            "}",
                                            "",
                                            "function main() {",
                                            "    PRE_UPDATE_SCRIPT_URL=\"$(sanitize_inputs {{PreUpdateScript}})\"",
                                            "    POST_UPDATE_SCRIPT_URL=\"$(sanitize_inputs {{PostUpdateScript}})\"",
                                            "    INCLUDE_PACKAGES=\"$(sanitize_inputs {{IncludePackages}})\"",
                                            "    EXCLUDE_PACKAGES=\"$(sanitize_inputs {{ExcludePackages}})\"",
                                            "    echo_options",
                                            "",
                                            "    if [ ! -z \"$PRE_UPDATE_SCRIPT_URL\" ]; then",
                                            "        run_hook_script \"$PRE_UPDATE_SCRIPT_URL\"",
                                            "    fi",
                                            "",
                                            "    update_cli",
                                            "    update_packages",
                                            "",
                                            "    if [ ! -z \"$POST_UPDATE_SCRIPT_URL\" ]; then",
                                            "        run_hook_script \"$POST_UPDATE_SCRIPT_URL\"",
                                            "    fi",
                                            "",
                                            "    exit 0",
                                            "}",
                                            "",
                                            "main \"$@\""
                                          ]
                                      }
                                  }
                              },
                              {
                                  "name": "stopInstance",
                                  "action": "aws:changeInstanceState",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "InstanceIds": [
                                          "{{ startInstances.InstanceIds }}"
                                      ],
                                      "DesiredState": "stopped"
                                  }
                              },
                              {
                                  "name": "createImage",
                                  "action": "aws:createImage",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 1,
                                  "onFailure": "Continue",
                                  "inputs": {
                                      "InstanceId": "{{ startInstances.InstanceIds }}",
                                      "ImageName": "{{ targetAMIname }}",
                                      "NoReboot": true,
                                      "ImageDescription": "AMI Generated by EC2 Automation on {{global:DATE_TIME}} from {{sourceAMIid}}"
                                  }
                              },
                              {
                                  "name": "TagTheAMI",
                                  "action": "aws:createTags",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Continue",
                                  "inputs": {
                                      "ResourceType": "EC2",
                                      "ResourceIds": [
                                          "{{ createImage.ImageId }}"
                                      ],
                                      "Tags": [
                                          {
                                              "Key": "ProductOSAndVersion",
                                              "Value": "{{productOSAndVersion}}"
                                          },
                                          {
                                              "Key": "ProductName",
                                              "Value": "{{productName}}"
                                          },
                                          {
                                              "Key": "version",
                                              "Value": "{{AMIVersion}}"
                                          },
                                          {
                                              "Key": "AMI-Type",
                                              "Value": "Golden"
                                          }
                                      ]
                                  }
                              },
                              {
                                  "name": "terminateFirstInstance",
                                  "action": "aws:changeInstanceState",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Continue",
                                  "inputs": {
                                      "InstanceIds": [
                                          "{{ startInstances.InstanceIds }}"
                                      ],
                                      "DesiredState": "terminated"
                                  }
                              },
                              {
                                  "name": "createInstanceFromNewImage",
                                  "action": "aws:runInstances",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "ImageId": "{{ createImage.ImageId }}",
                                      "InstanceType": "{{instanceType}}",
                                      "MinInstanceCount": 1,
                                      "MaxInstanceCount": 1,
                                      "SubnetId": "{{ privatesubnetId }}",
                                      "SecurityGroupIds": [
                                          "{{ securityGroupId }}"
                                      ],
                                      "IamInstanceProfileName": "{{ ManagedInstanceProfile }}"
                                  }
                              },
                              {
                                "name": "waitForInstanceDiscovery",
                                "action": "aws:sleep",
                                "inputs": {
                                    "Duration": "PT10M"
                                }
                            },
                              {
                                "maxAttempts": 1,
                                "inputs": {
                                  "Parameters": {
                                    "commands": [
                                      "set -e",
                                      "sudo su",
                                      "if cat /etc/*release | grep ^NAME | grep Amazon; then",
                                        "yum install -y jq",
                                        "yum install -y awscli",
                                        "if getent passwd | grep ec2-user; then",
                                        "USERNAME=\"ec2-user\"",
                                        "else",
                                        "echo \"Error: ec2-user not found\"",
                                        "fi",
                                      "elif cat /etc/*release | grep ^NAME | grep CentOS; then",
                                        "yum install -y jq",
                                        "yum install -y awscli",
                                        "if getent passwd | grep centos; then",
                                        "USERNAME=\"centos\"",
                                        "elif getent passwd | grep ec2-user; then",
                                        "USERNAME=\"ec2-user\"",
                                        "fi",
                                      "elif cat /etc/*release | grep ^NAME | grep Red; then",
                                        "yum install -y jq",
                                        "yum install -y awscli",
                                        "if getent passwd | grep root; then",
                                        "USERNAME=\"root\"",
                                        "elif getent passwd | grep ec2-user; then",
                                        "USERNAME=\"ec2-user\"",
                                        "fi",
                                      "elif cat /etc/*release | grep ^NAME | grep Fedora; then",
                                        "yum install -y jq",
                                        "yum install -y awscli",
                                        "if getent passwd | grep fedora; then",
                                        "USERNAME=\"fedora\"",
                                        "elif getent passwd | grep ec2-user; then",
                                        "USERNAME=\"ec2-user\"",
                                        "fi",
                                      "elif cat /etc/*release | grep ^NAME | grep Ubuntu; then",
                                        "apt-get update",
                                        "apt-get install -y jq",
                                        "apt-get install -y awscli",
                                        "if getent passwd | grep ubuntu; then",
                                        "USERNAME=\"ubuntu\"",
                                        "elif getent passwd | grep ec2-user; then",
                                        "USERNAME=\"ec2-user\"",
                                        "fi",
                                      "elif cat /etc/*release | grep ^NAME | grep Debian ; then",
                                        "apt-get update",
                                        "apt-get install -y jq",
                                        "apt-get install -y awscli",
                                        "if getent passwd | grep admin; then",
                                        "USERNAME=\"admin\"",
                                        "elif getent passwd | grep ec2-user; then",
                                        "USERNAME=\"ec2-user\"",
                                        "fi",
                                      "else",
                                        "echo \"OS not supported\"",
                                        "exit 1;",
                                      "fi",
                                      "REGION=\"{{global:REGION}}\"",
                                      "AMI_ID=$(curl -s 'http://169.254.169.254/latest/meta-data/ami-id')",
                                      "host_name=$(hostname -s)",
                                      "keyname=tenable-key-$host_name-{{global:DATE_TIME}}",
                                      "accessKey=$(aws ssm get-parameter --with-decryption --region $REGION --name {{tenableApiKey}} --query 'Parameter.Value' --output text)",
                                      "secretKey=$(aws ssm get-parameter --with-decryption --region $REGION --name {{tenableSecretKey}} --query 'Parameter.Value' --output text)",
                                      "list=$(curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" https://cloud.tenable.com/scanners/)",
                                      "scanner_id=$(echo $list | jq '.scanners' | jq '.[] | select(.name==\"{{tenableScannerName}}\")' | jq '.id')",
                                      "SSHDIR=$(pwd)",
                                      "if [ -d \"/home/$USERNAME/.ssh\" ]; then",
                                        "if [ -d \"$SSHDIR/.ssh\" ]; then",
                                          "echo \"$SSHDIR/.ssh directory exists\"",
                                        "else",
                                          "echo \"$SSHDIR/.ssh directory does not exist hence creating it\"",
                                          "sudo mkdir $SSHDIR/.ssh",
                                        "fi",
                                        "echo \".ssh directory exists in user's home\"",
                                      "else",
                                        "echo \".ssh directory does not exist in user's home hence creating it\"",
                                        "sudo mkdir /home/$USERNAME/.ssh",
                                      "fi",
                                      "ssh-keygen -m PEM -t rsa -C $keyname -f $SSHDIR/.ssh/$keyname.pem -q -N ''",
                                      "cat $SSHDIR/.ssh/$keyname.pem.pub >> /home/$USERNAME/.ssh/authorized_keys",
                                      "echo \"setting permissions on key\"",
                                      "chmod 0400 $SSHDIR/.ssh/$keyname.pem",
                                      "aws ec2 import-key-pair --region $REGION --key-name $keyname --public-key-material file://$SSHDIR/.ssh/$keyname.pem.pub",
                                      "service sshd restart",
                                      "cd $SSHDIR/.ssh",
                                      "curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" -H \"Accept: application/json\" -H \"Content-Type: multipart/form-data\" -F \"Filedata=@$keyname.pem\" -X POST https://cloud.tenable.com/file/upload>vm-key-upload-log.txt",
                                      "sleep 2m",
                                      "templates=$(curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" https://cloud.tenable.com/editor/policy/templates)",
                                      "uuid=$(echo $templates | jq '.templates' | jq '.[] | select(.title==\"{{tenableScanType}}\")' | jq '.uuid')",
                                      "curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" -H \"Content-Type: application/json\" -d '{\"uuid\": '$uuid',\"credentials\":{\"add\":{\"Host\":{\"SSH\":[{\"private_key\":\"'$keyname'.pem\",\"username\":\"'$USERNAME'\",\"auth_method\":\"public key\"}]}}}, \"settings\":{\"name\":\"CandidateAMIScan-'$AMI_ID'-{{global:DATE_TIME}}\", \"text_targets\":\"{{createInstanceFromNewImage.InstanceIds}}\",\"scanner_id\":'$scanner_id',\"emails\":\"{{EmailID}}\", \"enabled\":'true'}}' -X POST https://cloud.tenable.com/scans>vm-scan-create-log.json",
                                      "scan_id=$(jq . vm-scan-create-log.json | jq .'scan' | jq .'id')",
                                      "curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" -H \"Content-Type: application/json\" -X POST https://cloud.tenable.com/scans/$scan_id/launch>vm-scan-launch-log.json"
                                    ]
                                  },
                                  "InstanceIds": [
                                    "{{ createInstanceFromNewImage.InstanceIds }}"
                                  ],
                                  "DocumentName": "AWS-RunShellScript"
                                },
                                "name": "LaunchtenableAssessment",
                                "action": "aws:runCommand",
                                "timeoutSeconds": 3600,
                                "onFailure": "Abort"
                              },
                              {
                                  "name": "waitForAssessment",
                                  "action": "aws:sleep",
                                  "inputs": {
                                      "Duration": "PT15M"
                                  }
                              },
                              {
                                "maxAttempts": 1,
                                "inputs": {
                                    "Parameters": {
                                        "commands": [
                                            "REGION=\"{{global:REGION}}\"",
                                            "SSHDIR=$(pwd)",
                                            "keyname=$(basename -- $(find $SSHDIR/.ssh -type f -iname \"tenable-key-*.pem\"))",
                                            "keyname=$(echo ${keyname%.pem})",
                                            "echo 'Deleting key pair'",
                                            "aws ec2 delete-key-pair --region $REGION --key-name $keyname"
                                        ]
                                    },
                                    "InstanceIds": [
                                       "{{ createInstanceFromNewImage.InstanceIds }}"
                                    ],
                                    "DocumentName": "AWS-RunShellScript"
                                },
                                "name": "DeleteKeyPair",
                                "action": "aws:runCommand",
                                "timeoutSeconds": 3600,
                                "onFailure": "Abort"
                             },
                              {
                                  "name": "TagNewinstance",
                                  "action": "aws:createTags",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 1,
                                  "onFailure": "Continue",
                                  "inputs": {
                                      "ResourceType": "EC2",
                                      "ResourceIds": [
                                          "{{ createInstanceFromNewImage.InstanceIds }}"
                                      ],
                                      "Tags": [
                                          {
                                              "Key": "Type",
                                              "Value": "{{createImage.ImageId}}-{{productOSAndVersion}}/{{productName}}/{{AMIVersion}}"
                                          },
                                           {
                                              "Key": "Automation-Instance-Type",
                                              "Value": "Golden"
                                          }
                                      ]
                                  }
                              },
                              {
                                  "name": "StoreVersion",
                                  "action": "aws:invokeLambdaFunction",
                                  "maxAttempts": 3,
                                  "timeoutSeconds": 120,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "FunctionName": { "Ref": "StoreVersionLambdaFunction"},
                                      "Payload": {
                                          "Fn::Join": [
                                              "",
                                              [
                                                  "{\"AMI-ID\": \"{{createImage.ImageId}}\",\"topicArn\":\"",
                                                  "\",\"instanceId\": \"{{ createInstanceFromNewImage.InstanceIds }}\",\"productOS\": \"{{productOSAndVersion}}\",\"productName\": \"{{productName}}\",\"productVersion\": \"{{AMIVersion}}\"}"
                                              ]
                                          ]
                                      }
                                  }
                              },
                              {
                                  "name": "sleep",
                                  "action": "aws:sleep",
                                  "inputs": {
                                      "Duration": "PT02M"
                                  }
                              },
                              {
                                "maxAttempts": 1,
                                "inputs": {
                                  "DesiredState": "terminated",
                                  "InstanceIds": [
                                    "{{ createInstanceFromNewImage.InstanceIds }}"
                                  ]
                                },
                                "name": "terminatetenableInstance",
                                "action": "aws:changeInstanceState",
                                "timeoutSeconds": 1200,
                                "onFailure": "Continue"
                              },
                              {
                                  "name": "addNewVersionParameter",
                                  "action": "aws:invokeLambdaFunction",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 1,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "FunctionName":{ "Ref": "AppendParamLambda"},

                                      "Payload": "{\"parameterName\":\"/GoldenAMI/{{productOSAndVersion}}/{{productName}}/{{AMIVersion}}\", \"valueToBeCreatedOrAppended\":\"{{createImage.ImageId}}\"}"
                                  }
                              },
                              {
                                  "name": "approve",
                                  "action": "aws:approve",
                                  "timeoutSeconds": 172800,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "NotificationArn": "{{ ApproverNotificationArn }}",
                                      "Message": "Please check your report from tenable, and decide whether to approve this AMI- {{createImage.ImageId}}",
                                      "MinRequiredApprovals": 1,
                                      "Approvers": [
                                          "{{ ApproverUserIAMARN1 }}",
                                          "{{ ApproverUserIAMARN2 }}",
                                          "{{ ApproverUserIAMARN3 }}"
                                      ]
                                  }
                              },
                               {
                                  "name": "updateLatestVersionValue",
                                  "action": "aws:invokeLambdaFunction",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 1,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "FunctionName":{ "Ref": "AppendParamLambda"},
                                      "Payload": "{\"parameterName\":\"/GoldenAMI/latest\", \"valueToBeCreatedOrAppended\":\"{{createImage.ImageId}}\"}"
                                  }
                              }
                          ],
                          "outputs": [
                              "createImage.ImageId"
                          ]
                      }
                  }
              },

      "WindowsGoldenAMIAutomationDoc": {
                  "Type": "AWS::SSM::Document",
                  "Properties": {
                      "DocumentType": "Automation",
                      "Content": {
                          "description": "This automation document triggers Golden AMI creation workflow for Microsoft Windows AMI. By default it will install all Windows updates, Amazon software, and Amazon drivers. It will then sysprep and create a new AMI. Supports Windows Server 2008 R2 and greater..",
                          "schemaVersion": "0.3",
                          "assumeRole": {
                              "Fn::GetAtt": [
                                  "AutomationServiceRole",
                                  "Arn"
                              ]
                          },
                          "parameters": {
                              "SourceAmiId": {
                                  "type": "String",
                                  "description": "Source/Base AMI to be used for generating your golden AMI",
                                  "default": "<ENTER AMI ID>"
                              },
    
                              "tenableApiKey": {
                              "default": "/GoldenAMI/tenable/tenableApiKey",
                              "description": "SSM parameter name of tenable API Key to access API",
                              "type": "String"
                              },
    
                              "tenableSecretKey": {
                              "default": "/GoldenAMI/tenable/tenableSecretKey",
                              "description": "SSM parameter name of the tenable API Secret Key to access API",
                              "type": "String"
                              },
    
                              "tenableScannerName": {
                              "default": "{{ssm:/GoldenAMI/tenable/tenableScannerName}}",
                              "description": "Scanner name for launching tenable VM Scan",
                              "type": "String"
                              },
    
                              "tenableScanType": {
                              "default": "{{ssm:/GoldenAMI/tenable/tenableScanType}}",
                              "description": "SCAN TYPE for launching tenable VM Scan",
                              "type": "String"
                              },
    
                              "tenableApiUrl": {
                              "type": "String",
                              "description": "Your tenable URL for accessing API",
                              "default": {
                                  "Ref": "tenableApiUrl"
                                  }
                              },
    
                              "productName": {
                                  "type": "String",
                                  "description": "The syntax of this parameter is ProductName-ProductVersion.",
                                  "default": {
                                      "Ref": "productName"
                              }
                              },
    
                              "productOSAndVersion": {
                                  "type": "String",
                                  "description": "The syntax of this parameter is OSName-OSVersion",
                                  "default": {
                                      "Ref": "productOSAndVersion"
                                  }
                              },
    
                              "AMIVersion": {
                                  "type": "String",
                                  "description": "Golden AMI Build version number to be created.",
                                  "default": {
                                      "Ref": "buildVersion"
                                  }
                              },
    
                              "subnetId": {
                                  "type": "String",
                                  "default":{
                                      "Ref": "subnetPublic"
                                  },
                                  "description": "Subnet in which instances will be launched."
                              },
                            
                              "privatesubnetId": {
                                  "type": "String",
                                  "default":{
                                      "Ref": "subnetPrivate"
                                  },
                                  "description": "Subnet in which instances will be launched."
                              },
    
                              "securityGroupId": {
                                  "type": "String",
                                  "default":{
                                      "Ref": "secGroup"
                                  },
                                  "description": "Security Group that will be attached to the instance. By Default a security group without any inbound access is attached"
                              },
    
                              "instanceType": {
                                  "type": "String",
                                  "description": "A compatible instance-type for launching an instance",
                                  "default": {
                                      "Ref": "instanceType"
                                  }
                              },
      
                              "TargetAmiName": {
                                  "type": "String",
                                  "description": "Name for the golden AMI to be created",
                                  "default": "{{productName}}-{{productOSAndVersion}}-{{AMIVersion}}"
                              },
      
                              "TargetImageDescription": {
                                  "type": "String",
                                  "description": "(Optional) The description of the new AMI that will be created.",
                                  "default": "Updated Windows Ami from {{SourceAmiId}} on {{global:DATE_TIME}}"
                                },
    
                              "ApproverUserIAMARN1": {
                                  "type": "String",
                                  "description": "IAM ARN of the user who has SSM approval permissions.",
                                  "default": {
                                      "Ref": "ApproverUserIAMARN1"
                                  }
                              },
                              "ApproverUserIAMARN2": {
                                  "type": "String",
                                  "description": "IAM ARN of the user who has SSM approval permissions.",
                                  "default": {
                                      "Ref": "ApproverUserIAMARN2"
                                  }
                              },
    
                              "ApproverUserIAMARN3": {
                                  "type": "String",
                                  "description": "IAM ARN of the user who has SSM approval permissions.",
                                  "default": {
                                      "Ref": "ApproverUserIAMARN3"
                                  }
                              },
      
                              "ApproverNotificationArn": {
                                  "type": "String",
                                  "description": "SNS Topic ARN on which a notification would be published once the golden AMI candidate is ready for validation.",
                                  "default": {
                                      "Ref": "ApproverNotification"
                                  }
                              },
    
                              "ManagedInstanceProfile": {
                                  "type": "String",
                                  "description": "Instance Profile. Do not change the default value.",
                                  "default": {
                                      "Ref": "ManagedInstanceProfile"
                                  }
                              }, 
    
                              "EmailID": {
                                  "type": "String",
                                  "description": "Email ID of the admin who will receive scan assessment reports from Tenable",
                                  "default": {
                                      "Ref": "EmailID"
                                      }
                                  },
      
                              "SSMInstallationUserData": {
                                  "type": "String",
                                  "description": "Base64 encoded SSM installation user-data.",
                                  "default": "IyEvYmluL2Jhc2gNCg0KZnVuY3Rpb24gZ2V0X2NvbnRlbnRzKCkgew0KICAgIGlmIFsgLXggIiQod2hpY2ggY3VybCkiIF07IHRoZW4NCiAgICAgICAgY3VybCAtcyAtZiAiJDEiDQogICAgZWxpZiBbIC14ICIkKHdoaWNoIHdnZXQpIiBdOyB0aGVuDQogICAgICAgIHdnZXQgIiQxIiAtTyAtDQogICAgZWxzZQ0KICAgICAgICBkaWUgIk5vIGRvd25sb2FkIHV0aWxpdHkgKGN1cmwsIHdnZXQpIg0KICAgIGZpDQp9DQoNCnJlYWRvbmx5IElERU5USVRZX1VSTD0iaHR0cDovLzE2OS4yNTQuMTY5LjI1NC8yMDE2LTA2LTMwL2R5bmFtaWMvaW5zdGFuY2UtaWRlbnRpdHkvZG9jdW1lbnQvIg0KcmVhZG9ubHkgVFJVRV9SRUdJT049JChnZXRfY29udGVudHMgIiRJREVOVElUWV9VUkwiIHwgYXdrIC1GXCIgJy9yZWdpb24vIHsgcHJpbnQgJDQgfScpDQpyZWFkb25seSBERUZBVUxUX1JFR0lPTj0idXMtZWFzdC0xIg0KcmVhZG9ubHkgUkVHSU9OPSIke1RSVUVfUkVHSU9OOi0kREVGQVVMVF9SRUdJT059Ig0KDQpyZWFkb25seSBTQ1JJUFRfTkFNRT0iYXdzLWluc3RhbGwtc3NtLWFnZW50Ig0KIFNDUklQVF9VUkw9Imh0dHBzOi8vYXdzLXNzbS1kb3dubG9hZHMtJFJFR0lPTi5zMy5hbWF6b25hd3MuY29tL3NjcmlwdHMvJFNDUklQVF9OQU1FIg0KDQppZiBbICIkUkVHSU9OIiA9ICJjbi1ub3J0aC0xIiBdOyB0aGVuDQogIFNDUklQVF9VUkw9Imh0dHBzOi8vYXdzLXNzbS1kb3dubG9hZHMtJFJFR0lPTi5zMy5jbi1ub3J0aC0xLmFtYXpvbmF3cy5jb20uY24vc2NyaXB0cy8kU0NSSVBUX05BTUUiDQpmaQ0KDQppZiBbICIkUkVHSU9OIiA9ICJ1cy1nb3Ytd2VzdC0xIiBdOyB0aGVuDQogIFNDUklQVF9VUkw9Imh0dHBzOi8vYXdzLXNzbS1kb3dubG9hZHMtJFJFR0lPTi5zMy11cy1nb3Ytd2VzdC0xLmFtYXpvbmF3cy5jb20vc2NyaXB0cy8kU0NSSVBUX05BTUUiDQpmaQ0KDQpjZCAvdG1wDQpGSUxFX1NJWkU9MA0KTUFYX1JFVFJZX0NPVU5UPTMNClJFVFJZX0NPVU5UPTANCg0Kd2hpbGUgWyAkUkVUUllfQ09VTlQgLWx0ICRNQVhfUkVUUllfQ09VTlQgXSA7IGRvDQogIGVjaG8gQVdTLVVwZGF0ZUxpbnV4QW1pOiBEb3dubG9hZGluZyBzY3JpcHQgZnJvbSAkU0NSSVBUX1VSTA0KICBnZXRfY29udGVudHMgIiRTQ1JJUFRfVVJMIiA+ICIkU0NSSVBUX05BTUUiDQogIEZJTEVfU0laRT0kKGR1IC1rIC90bXAvJFNDUklQVF9OQU1FIHwgY3V0IC1mMSkNCiAgZWNobyBBV1MtVXBkYXRlTGludXhBbWk6IEZpbmlzaGVkIGRvd25sb2FkaW5nIHNjcmlwdCwgc2l6ZTogJEZJTEVfU0laRQ0KICBpZiBbICRGSUxFX1NJWkUgLWd0IDAgXTsgdGhlbg0KICAgIGJyZWFrDQogIGVsc2UNCiAgICBpZiBbWyAkUkVUUllfQ09VTlQgLWx0IE1BWF9SRVRSWV9DT1VOVCBdXTsgdGhlbg0KICAgICAgUkVUUllfQ09VTlQ9JCgoUkVUUllfQ09VTlQrMSkpOw0KICAgICAgZWNobyBBV1MtVXBkYXRlTGludXhBbWk6IEZpbGVTaXplIGlzIDAsIHJldHJ5Q291bnQ6ICRSRVRSWV9DT1VOVA0KICAgIGZpDQogIGZpIA0KZG9uZQ0KDQppZiBbICRGSUxFX1NJWkUgLWd0IDAgXTsgdGhlbg0KICBjaG1vZCAreCAiJFNDUklQVF9OQU1FIg0KICBlY2hvIEFXUy1VcGRhdGVMaW51eEFtaTogUnVubmluZyBVcGRhdGVTU01BZ2VudCBzY3JpcHQgbm93IC4uLi4NCiAgLi8iJFNDUklQVF9OQU1FIiAtLXJlZ2lvbiAiJFJFR0lPTiINCmVsc2UNCiAgZWNobyBBV1MtVXBkYXRlTGludXhBbWk6IFVuYWJsZSB0byBkb3dubG9hZCBzY3JpcHQsIHF1aXR0aW5nIC4uLi4NCmZp"
                              },
      
                              "PreUpdateScript": {
                                  "type": "String",
                                  "description": "(Optional) URL of a script to run before updates are applied. Default (\"none\") is to not run a script.",
                                  "default": "none"
                              },
     
                              "PostUpdateScript": {
                                  "type": "String",
                                  "description": "(Optional) URL of a script to run after package updates are applied. Default (\"none\") is to not run a script.",
                                  "default": "none"
                              },
      
                              "IncludeKbs": {
                                  "type": "String",
                                  "description": "(Optional) Specify one or more Microsoft Knowledge Base (KB) article IDs to include. You can install multiple IDs using comma-separated values. Valid formats: KB9876543 or 9876543.",
                                  "default": ""
                                },
      
                              "ExcludeKbs": {
                                  "type": "String",
                                  "description": "(Optional) Specify one or more Microsoft Knowledge Base (KB) article IDs to exclude. You can exclude multiple IDs using comma-separated values. Valid formats: KB9876543 or 9876543.",
                                  "default": ""
                                },
    
                              "Categories": {
                                  "type": "String",
                                  "description": "(Optional) Specify one or more update categories. You can filter categories using comma-separated values. Options: Application, Connectors, CriticalUpdates, DefinitionUpdates, DeveloperKits, Drivers, FeaturePacks, Guidance, Microsoft, SecurityUpdates, ServicePacks, Tools, UpdateRollups, Updates. Valid formats include a single entry, for example: CriticalUpdates. Or you can specify a comma separated list: CriticalUpdates,SecurityUpdates. NOTE: There cannot be any spaces around the commas.",
                                  "default": ""
                                },
    
                              "SeverityLevels": {
                                  "type": "String",
                                  "description": "(Optional) Specify one or more MSRC severity levels associated with an update. You can filter severity levels using comma-separated values. By default patches for all security levels are selected. If value supplied, the update list is filtered by those values. Options: Critical, Important, Low, Moderate or Unspecified. Valid formats include a single entry, for example: Critical. Or, you can specify a comma separated list: Critical,Important,Low.",
                                  "default": ""
                                },
      
                              "PublishedDaysOld": {
                                  "type": "String",
                                  "default": "",
                                  "description": "(Optional) Specify the amount of days old the updates must be from the published date.  For example, if 10 is specified, any updates that were found during the Windows Update search that have been published 10 or more days ago will be returned."
                                },
      
                              "PublishedDateAfter": {
                                  "type": "String",
                                  "default": "",
                                  "description": "(Optional) Specify the date that the updates should be published after.  For example, if 01/01/2017 is specified, any updates that were found during the Windows Update search that have been published on or after 01/01/2017 will be returned."
                                },
      
                              "PublishedDateBefore": {
                                  "type": "String",
                                  "default": "",
                                  "description": "(Optional) Specify the date that the updates should be published before.  For example, if 01/01/2017 is specified, any updates that were found during the Windows Update search that have been published on or before 01/01/2017 will be returned."
                                }
      
                          },
                          "mainSteps": [
                              {
                                  "name": "startInstances",
                                  "action": "aws:runInstances",
                                  "timeoutSeconds": 1800,
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "inputs": {
                                    "ImageId": "{{ SourceAmiId  }}",
                                    "InstanceType": "{{ instanceType }}",
                                    "MinInstanceCount": 1,
                                    "MaxInstanceCount": 1,
                                    "IamInstanceProfileName": "{{ ManagedInstanceProfile }}",
                                    "SubnetId": "{{ privatesubnetId }}",
                                    "SecurityGroupIds": [
                                        "{{ securityGroupId }}"
                                    ]
                                  }
                              },
                              {
                                  "name": "OSCompatibilityCheck",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 7200,
                                  "inputs": {
                                    "DocumentName": "AWS-RunPowerShellScript",
                                    "InstanceIds": [
                                      "{{startInstances.InstanceIds}}"
                                    ],
                                    "Parameters": {
                                      "executionTimeout": "7200",
                                      "commands": [
                                        "[System.Version]$osversion = [System.Environment]::OSVersion.Version",
                                        "if(($osversion.Major -eq 6 -and $osversion.Minor -ge 1) -or ($osversion.Major -ge 10)) {",
                                        "  Write-Host 'This OS is supported for use with this automation document.'",
                                        "} else {",
                                        "  Write-Host 'This OS is not supported for use with this automation document.'",
                                        "  exit -1",
                                        "}"
                                      ]
                                    }
                                  }
                              },
                              {
                                  "name": "RunPreUpdateScript",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 1800,
                                  "inputs": {
                                    "DocumentName": "AWS-RunPowerShellScript",
                                    "InstanceIds": [
                                      "{{ startInstances.InstanceIds }}"
                                    ],
                                    "Parameters": {
                                      "commands": "{{ PreUpdateScript }}"
                                    }
                                  }
                              },
                              {
                                  "name": "UpdateEC2Config",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 7200,
                                  "inputs": {
                                    "DocumentName": "AWS-RunPowerShellScript",
                                    "InstanceIds": [
                                      "{{ startInstances.InstanceIds }}"
                                   ],
                                    "Parameters": {
                                      "commands": [
                                        "$zipFilename = 'AWSUpdateWindowsInstance_1_4_4_0.zip'",
                                        "$zipFileHash = 'CD337ADCFBA463DE895B8D8248A3991940ABB03ADF8525ECA1302385D6A1DDA6'",
                                        "$moduleName = 'AWSUpdateWindowsInstance'",
                                        "$tempPath = $env:TEMP",
                                        "$moduleDirectory = Join-Path $tempPath -ChildPath $moduleName",
                                        "$moduleZipFilePath = Join-Path $tempPath -ChildPath $zipFilename",
                                        "$moduleManifestPath = Join-Path $moduleDirectory -ChildPath ('{0}.psd1' -f $moduleName)",
                                        "[string[]] $includeList = ('{{ IncludeKbs }}').Split(',',[System.StringSplitOptions]::RemoveEmptyEntries)",
                                        "[string[]] $excludeList = ('{{ ExcludeKbs }}').Split(',',[System.StringSplitOptions]::RemoveEmptyEntries)",
                                        "[string[]] $categoryList = ('{{ Categories }}').Split(',',[System.StringSplitOptions]::RemoveEmptyEntries)",
                                        "[string[]] $severityLevelList = ('{{ SeverityLevels }}').Split(',',[System.StringSplitOptions]::RemoveEmptyEntries)",
                                        "[string]$publishedDateAfter = '{{ PublishedDateAfter }}'",
                                        "[string]$publishedDateBefore = '{{ PublishedDateBefore }}'",
                                        "[string]$publishedDaysOld = '{{ PublishedDaysOld }}'",
                                        "",
                                        "$ssmAgentService = Get-ItemProperty 'HKLM:SYSTEM\\CurrentControlSet\\Services\\AmazonSSMAgent\\' -ErrorAction SilentlyContinue",
                                        "if($ssmAgentService -and $ssmAgentService.Version -ge '2.0.533.0') {",
                                        "  $region = $env:AWS_SSM_REGION_NAME",
                                        "}",
                                        "",
                                        "if(-not $region) {",
                                        "  try {",
                                        "    $tokenUrl = 'http://169.254.169.254/latest/api/token'",
                                        "    $token = (Invoke-WebRequest -Method PUT -Headers @{'X-aws-ec2-metadata-token-ttl-seconds'='21600'}  -uri $tokenUrl).Content",
                                        "    $identityDocumentUrl = 'http://169.254.169.254/latest/dynamic/instance-identity/document'",
                                        "    $region = ((Invoke-WebRequest -UseBasicParsing -Headers @{'X-aws-ec2-metadata-token'=$token} -uri $identityDocumentUrl).Content | ConvertFrom-Json).region",
                                        "  } catch {",
                                        "    $region = 'us-east-1'",
                                        "  }",
                                        "}",
                                        "",
                                        "function Main {",
                                        "  Test-PreCondition",
                                        "  Clear-WindowsUpdateModule",
                                        "  Get-WindowsUpdateModule",
                                        "  Expand-WindowsUpdateModule",
                                        "  $ec2launchV2 = \"$($env:ProgramFiles)\\Amazon\\EC2Launch\\EC2Launch.exe\"",
                                        "",
                                        "  if (Test-Path $ec2launchV2) {",
                                        "    return",
                                        "  }",
                                        "",
                                        "  if ([Environment]::OSVersion.Version.Major -ge 10) {",
                                        "    Invoke-UpdateEC2Launch",
                                        "  } else {",
                                        "    Invoke-UpdateEC2Config",
                                        "  }",
                                        "}",
                                        "",
                                        "function Test-PreCondition {",
                                        "  try {",
                                        "    $osversion = [Environment]::OSVersion.Version",
                                        "    if ($osversion.Major -le 5) {",
                                        "      Write-Host 'This document is not supported on Windows Server 2003 or earlier.'",
                                        "      Exit -1",
                                        "    }",
                                        "",
                                        "    if ($osversion.Version -ge '10.0') {",
                                        "      $sku = (Get-CimInstance -ClassName Win32_OperatingSystem).OperatingSystemSKU",
                                        "      if ($sku -eq 143 -or $sku -eq 144) {",
                                        "        Write-Host 'This document is not supported on Windows 2016 Nano Server.'",
                                        "        Exit -1",
                                        "      }",
                                        "    }",
                                        "  } catch {",
                                        "    Write-Host 'Executing Test-PreCondition resulted in error: $($_)'",
                                        "    Exit -1",
                                        "  }",
                                        "  }",
                                        "",
                                        "function Clear-WindowsUpdateModule {",
                                        "  try {",
                                        "    if (Test-Path $moduleDirectory) {",
                                        "      Remove-Item $moduleDirectory -Force -Recurse",
                                        "    }",
                                        "    if (Test-Path $moduleZipFilePath) {",
                                        "      Remove-Item $moduleZipFilePath -Force",
                                        "    }",
                                        "  } catch {",
                                        "    Write-Host \"Cleaning Windows update module resulted in error: $($_)\"",
                                        "  }",
                                        "}",
                                        "",
                                        "function Get-WindowsUpdateModule {",
                                        "  try {",
                                        "    if ($region.StartsWith('cn-')) {",
                                        "      $s3Location = 'https://s3.{0}.amazonaws.com.cn/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'",
                                        "    } elseif($region.StartsWith('us-gov-')) {",
                                        "      $s3Location = 'https://s3-fips-{0}.amazonaws.com/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'",
                                        "    } elseif($region -eq 'us-east-1') {",
                                        "      $s3Location = 'https://s3.amazonaws.com/aws-windows-downloads-{0}/PSModules/AWSUpdateWindowsInstance/{1}'",
                                        "    } else {",
                                        "      $s3Location = 'https://aws-windows-downloads-{0}.s3.amazonaws.com/PSModules/AWSUpdateWindowsInstance/{1}'",
                                        "    }",
                                        "",
                                        "    $source = $s3Location -f $region, $zipFilename",
                                        "    $moduleLocalPath = Join-Path $tempPath -ChildPath $zipFilename",
                                        "    Start-BitsTransfer -Source $source -Destination $moduleLocalPath",
                                        "",
                                        "    $fileStream = New-Object System.IO.FileStream($moduleLocalPath, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read)",
                                        "    $sha256 = [System.Security.Cryptography.HashAlgorithm]::Create('System.Security.Cryptography.SHA256CryptoServiceProvider')",
                                        "    $currentHash = [System.BitConverter]::ToString($sha256.ComputeHash($fileStream), 0).Replace('-', '').ToLowerInvariant()",
                                        "    $sha256.Dispose()",
                                        "    $fileStream.Dispose()",
                                        "",
                                        "    if ($currentHash -ne $zipFileHash) {",
                                        "      Write-Host 'The SHA hash of the module does not match the expected value.'",
                                        "      Exit -1",
                                        "    }",
                                        "  } catch {",
                                        "    Write-Host ('Error encountered while getting the module: {0}.' -f $_.Exception.Message)",
                                        "    Exit -1",
                                        "  }",
                                        "}",
                                        "",
                                        "function Expand-WindowsUpdateModule {",
                                        "  try {",
                                        "    [System.Reflection.Assembly]::LoadWithPartialName('System.IO.Compression.FileSystem') | Out-Null",
                                        "    $zip = [System.IO.Compression.ZipFile]::OpenRead($moduleZipFilePath)",
                                        "    foreach ($item in $zip.Entries) {",
                                        "      $extractPath = Join-Path $tempPath -ChildPath $item.FullName",
                                        "      if ($item.Length -eq 0) {",
                                        "        if (-not (Test-Path $extractPath)) {",
                                        "          New-Item $extractPath -ItemType Directory | Out-Null",
                                        "        }",
                                        "      } else {",
                                        "        $parentPath = Split-Path $extractPath",
                                        "        if (-not (Test-Path $parentPath)) {",
                                        "          New-Item $parentPath -ItemType Directory | Out-Null",
                                        "        }",
                                        "        [System.IO.Compression.ZipFileExtensions]::ExtractToFile($item, $extractPath, $true)",
                                        "      }",
                                        "    }",
                                        "  } catch {",
                                        "    Write-Host ('Error encountered when extracting module file: {0}.' -f $_.Exception.Message)",
                                        "    Exit -1",
                                        "  } finally {",
                                        "    $zip.Dispose()",
                                        "  }",
                                        "}",
                                        "",
                                        "function Invoke-UpdateEC2Config {",
                                        "  try {",
                                        "    Import-Module $moduleManifestPath",
                                        "    $command = \"Install-AwsUwiEC2Config -Region $region\"",
                                        "    if($id) { $command += \" -Id $($id)\"}",
                                        "    Invoke-Expression $command",
                                        "  } catch {",
                                        "    Write-Host 'Executing Invoke-AwsUwiEC2Config resulted in error: $($_)'",
                                        "    Exit -1",
                                        "  }",
                                        "}",
                                        "",
                                        "function Invoke-UpdateEC2Launch {",
                                        "  try {",
                                        "    Import-Module $moduleManifestPath",
                                        "    $command = 'Install-AwsUwiEC2Launch'",
                                        "    if($id) { $command += \" -Id $($id)\" }",
                                        "    Invoke-Expression $command",
                                        "  } catch {",
                                        "    Write-Host 'Executing Invoke-AwsUwiEC2Launch resulted in error: $($_)'",
                                        "    Exit -1",
                                        "  }",
                                        "}",
                                        "",
                                        "Main"
                                      ]
                                    }
                                  }
                              },
                              {
                                  "name": "UpdateSSMAgent",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 600,
                                  "inputs": {
                                    "DocumentName": "AWS-UpdateSSMAgent",
                                    "InstanceIds": [
                                      "{{ startInstances.InstanceIds }}"
                                    ],
                                    "Parameters": {
                                      "allowDowngrade": "false"
                                    }
                                  }
                              },
                              {
                                  "name": "UpdateAWSPVDriver",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 600,
                                  "inputs": {
                                    "DocumentName": "AWS-ConfigureAWSPackage",
                                    "InstanceIds": [
                                      "{{startInstances.InstanceIds}}"
                                    ],
                                    "Parameters": {
                                      "name": "AWSPVDriver",
                                      "action": "Install"
                                    }
                                  }
                              },
                              {
                                  "name": "UpdateAWSEnaNetworkDriver",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 600,
                                  "inputs": {
                                    "DocumentName": "AWS-ConfigureAWSPackage",
                                    "InstanceIds": [
                                      "{{startInstances.InstanceIds}}"
                                    ],
                                    "Parameters": {
                                      "name": "AwsEnaNetworkDriver",
                                      "action": "Install"
                                    }
                                  }
                              },
                              {
                                  "name": "UpdateAWSNVMe",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 600,
                                  "inputs": {
                                    "DocumentName": "AWS-ConfigureAWSPackage",
                                    "InstanceIds": [
                                      "{{startInstances.InstanceIds}}"
                                    ],
                                    "Parameters": {
                                      "name": "AWSNVMe",
                                      "action": "Install"
                                    }
                                  }
                              },
                              {
                                  "name": "InstallWindowsUpdates",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 14400,
                                  "inputs": {
                                    "DocumentName": "AWS-InstallWindowsUpdates",
                                    "InstanceIds": [
                                      "{{ startInstances.InstanceIds }}"
                                    ],
                                    "Parameters": {
                                      "Action": "Install",
                                      "IncludeKbs": "{{ IncludeKbs }}",
                                      "ExcludeKbs": "{{ ExcludeKbs }}",
                                      "Categories": "{{ Categories }}",
                                      "SeverityLevels": "{{ SeverityLevels }}",
                                      "PublishedDaysOld": "{{ PublishedDaysOld }}",
                                      "PublishedDateAfter": "{{ PublishedDateAfter }}",
                                      "PublishedDateBefore": "{{ PublishedDateBefore }}"
                                    }
                                  }
                              },  
                              {
                                  "name": "RunPostUpdateScript",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 1800,
                                  "inputs": {
                                    "DocumentName": "AWS-RunPowerShellScript",
                                    "InstanceIds": [
                                      "{{ startInstances.InstanceIds }}"
                                    ],
                                    "Parameters": {
                                      "commands": "{{ PostUpdateScript }}"
                                    }
                                  }
                              }, 
                              {
                                  "name": "RunSysprepGeneralize",
                                  "action": "aws:runCommand",
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "timeoutSeconds": 600,
                                  "inputs": {
                                    "DocumentName": "AWSEC2-RunSysprep",
                                    "InstanceIds": [
                                      "{{startInstances.InstanceIds}}"
                                    ],
                                    "Parameters": {
                                      "Id": "{{automation:EXECUTION_ID}}"
                                    }
                                  }
                              },
                              {
                                  "name": "stopInstance",
                                  "action": "aws:changeInstanceState",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "InstanceIds": [
                                          "{{ startInstances.InstanceIds }}"
                                      ],
                                      "DesiredState": "stopped"
                                  }
                              },
                              {
                                  "name": "createImage",
                                  "action": "aws:createImage",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Continue",
                                  "inputs": {
                                      "InstanceId": "{{ startInstances.InstanceIds }}",
                                      "ImageName": "{{ TargetAmiName }}",
                                      "NoReboot": true,
                                      "ImageDescription": "{{ TargetImageDescription }}"
                                  }
                              },
                              {
                                  "name": "TagTheAMI",
                                  "action": "aws:createTags",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Continue",
                                  "inputs": {
                                      "ResourceType": "EC2",
                                      "ResourceIds": [
                                          "{{ createImage.ImageId }}"
                                      ],
                                      "Tags": [
                                          {
                                              "Key": "ProductOSAndVersion",
                                              "Value": "{{productOSAndVersion}}"
                                          },
                                          {
                                              "Key": "ProductName",
                                              "Value": "{{productName}}"
                                          },
                                          {
                                              "Key": "version",
                                              "Value": "{{AMIVersion}}"
                                          },
                                          {
                                              "Key": "AMI-Type",
                                              "Value": "Golden"
                                          }
                                      ]
                                  }
                              },
                              {
                                  "name": "terminateFirstInstance",
                                  "action": "aws:changeInstanceState",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Continue",
                                  "inputs": {
                                      "InstanceIds": [
                                          "{{ startInstances.InstanceIds }}"
                                      ],
                                      "DesiredState": "terminated"
                                  }
                              },
      
                              {
                                  "name": "createInstanceFromNewImage",
                                  "action": "aws:runInstances",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 3,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "ImageId": "{{ createImage.ImageId }}",
                                      "InstanceType": "{{instanceType}}",
                                      "MinInstanceCount": 1,
                                      "MaxInstanceCount": 1,
                                      "SubnetId": "{{ privatesubnetId }}",
                                      "SecurityGroupIds": [
                                          "{{ securityGroupId }}"
                                      ],
                                      "IamInstanceProfileName": "{{ ManagedInstanceProfile }}"
                                  }
                              },
                              {
                                  "name": "waitForInstanceDiscovery",
                                  "action": "aws:sleep",
                                  "inputs": {
                                    "Duration": "PT10M"
                                    }
                              },
                              {
                                "maxAttempts": 1,
                                "inputs": {
                                  "Parameters": {
                                  "commands": [
                                      "$ie = Start-Process -file iexplore -arg 'http://www.google.com' -PassThru",
                                      "Start-Sleep -s 5",
                                      "$ie.Kill()",
                                      "try{",
                                      "    Set-ExecutionPolicy AllSigned",
                                      "} catch {",
                                      "    Write-Host 'Warning:'",
                                      "    Write-Host $_",
                                      "}",
                                      "try {",
                                      "    $chocolatey_path = 'C:\\ProgramData\\chocolatey'",
                                      "    if(Test-Path -Path $chocolatey_path) {",
                                      "        try {",
                                      "            $testchoco = (choco -v)",
                                      "            if(-not($testchoco)) {",
                                      "                Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))",
                                      "            }",
                                      "            else {",
                                      "                Write-Host 'Seems like chocolatey is already installed'",
                                      "                }",
                                      "        } catch {",
                                      "            Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))",
                                      "        }",
                                      "    }",
                                      "    else {",
                                      "        Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))",
                                      "    }",
                                      "} catch {",
                                      "    Write-Host 'Chocolatey installation failed because of following error:'",
                                      "    Write-Host $_",
                                      "    Exit -1",
                                      "}",
                                      "try {",
                                      "    [int]$OsVersion = ((Get-ComputerInfo | select OsVersion).OsVersion).split('.')[0]",
                                      "    if ($OsVersion -ge 8) {",
                                      "        $smb_status = (Get-SmbServerConfiguration | Select EnableSMB2Protocol).EnableSMB2Protocol",
                                      "        $remote_registry = (Get-CimInstance -Class Win32_Service -Filter 'Name = \"RemoteRegistry\"').State",
                                      "        if ($smb_status -eq $false) {",
                                      "            Write-Host 'smb service is disabled, enabling it'",
                                      "            Set-SmbServerConfiguration -EnableSMB2Protocol $true -Force",
                                      "        }",
                                      "        if ($smb_status -eq $true) {",
                                      "            Write-Host 'smb service is enabled, moving on'",
                                      "        }",
                                      "        if ($remote_registry -like '*isabled') {",
                                      "            Write-Host 'remote registry service is disabled, enabling it'",
                                      "            Set-Service -Name RemoteRegistry -StartupType Automatic",
                                      "        }",
                                      "        if ($remote_registry -like '*nabled') {",
                                      "            Write-Host 'remote registry service is enabled'",
                                      "        }",
                                      "        if ($remote_registry -like '*topped') {",
                                      "            Write-Host 'remote registry service is stopped, starting it'",
                                      "            Start-Service -InputObject (Get-Service -Name RemoteRegistry)",
                                      "        }",
                                      "        if ($remote_registry -like '*unning') {",
                                      "            Write-Host 'remote registry service is running, moving on'",
                                      "        }",
                                      "    }",
                                      "    else {",
                                      "        $smb_status = (Get-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters | ForEach-Object {Get-ItemProperty $_.pspath}).State",
                                      "        if ($smb_status -like '*isabled') {",
                                      "            Write-Host 'smb service is disabled, enabling it'",
                                      "            Set-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters\" SMB2 -Type DWORD -Value 1 -Force",
                                      "         }",
                                      "        else {",
                                      "          Write-Host 'smb service is enabled, moving on'",
                                      "         }",
                                      "    }",
                                      "} catch {",
                                      "      Write-Host 'Some problem with smb status check, error:'",
                                      "      Write-Host $_",
                                      "      Exit -1",
                                      "}",
                                      "try{",
                                      "    shutdown -r",
                                      "} catch {",
                                      "    Write-Host 'Unable to reboot the system, error:'",
                                      "    Write-Host $_",
                                      "    Exit -1",
                                      "}"
                                    ]
                                  },
                                  "InstanceIds": [
                                      "{{ createInstanceFromNewImage.InstanceIds }}"
                                  ],
                                  "DocumentName": "AWS-RunPowerShellScript"
                                },
                              "name": "PrepForScan",
                              "action": "aws:runCommand",
                              "timeoutSeconds": 3600,
                              "onFailure": "Abort"
                              },
                              {
                                "name": "waitAfterInstanceRestart",
                                "action": "aws:sleep",
                                "inputs": {
                                  "Duration": "PT10M"
                                  }
                              },
                              {
                                  "maxAttempts": 1,
                                  "inputs": {
                                    "Parameters": {
                                    "commands": [
                                        "$ie = Start-Process -file iexplore -arg 'http://www.google.com' -PassThru",
                                        "Start-Sleep -s 5",
                                        "$ie.Kill()",
                                        "try {",
                                        "     Write-Host 'Disabling firewall for running the scan'",
                                        "     netsh advfirewall set allprofiles state off",
                                        "     Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False",
                                        "} catch {",
                                        "    Write-Host 'There was an error while disabling the firewall:'",
                                        "    Write-Host $_",
                                        "    Exit -1",
                                        "}",
                                        "try {",
                                        "    choco upgrade chocolatey",
                                        "    chocolatey install jq -y --force",
                                        "} catch {",
                                        "    Write-Host 'Unable to upgrade chocolatey, error:'",
                                        "    Write-Host $_",
                                        "    Exit -1",
                                        "}",
                                        "$REGION=\"{{global:REGION}}\"",
                                        "$AMI_ID=(Invoke-WebRequest -UseBasicParsing http://169.254.169.254/latest/meta-data/ami-id).Content",
                                        "$accessKey=(Get-SSMParameter -WithDecryption 1 -Region $REGION -Name /GoldenAMI/tenable/tenableApiKey).Value",
                                        "$secretKey=(Get-SSMParameter -WithDecryption 1 -Region $REGION -Name /GoldenAMI/tenable/tenableSecretKey).Value",
                                        "$headers=@{}",
                                        "$headers.Add(\"Accept\", \"application/json\")",
                                        "$headers.Add(\"Content-Type\", \"application/json\")",
                                        "$headers.Add(\"X-ApiKeys\", \"accessKey= $accessKey;secretKey= $secretKey\")",
                                        "$list=(Invoke-WebRequest -UseBasicParsing -Uri https://cloud.tenable.com/scanners/ -Headers $headers) | ConvertFrom-Json",
                                        "$scanner_id=(echo $list | ConvertTo-Json | jq '.scanners' | jq '.[] | select(.name==\\\"Nessus-Scanner\\\")' | jq '.id')",
                                        "function Get-RandomCharacters($length, $characters)",
                                        "{",
                                        "    try {",
                                        "        $random = 1..$length | ForEach-Object { Get-Random -Maximum $characters.length }",
                                        "        $private:ofs=''",
                                        "        return [String]$characters[$random]",
                                        "    } catch {",
                                        "        Write-Host 'Unable to generate randome string, error:'",
                                        "        Write-Host $_",
                                        "    }",
                                        "}",
                                        "function Scramble-String([string]$inputString)",
                                        "{",
                                        "    try {",
                                        "        $characterArray = $inputString.ToCharArray()",
                                        "        $scrambledStringArray = $characterArray | Get-Random -Count $characterArray.Length",
                                        "        $outputString = -join $scrambledStringArray",
                                        "        return $outputString",
                                        "    } catch {",
                                        "        Write-Host 'Unable to scramble string for the given random string, error:'",
                                        "        Write-Host $_",
                                        "    }",
                                        "}",
                                        "$password = Get-RandomCharacters -length 10 -characters 'abcdefghiklmnoprstuvwxyz'",
                                        "$password += Get-RandomCharacters -length 10 -characters 'ABCDEFGHKLMNOPRSTUVWXYZ'",
                                        "$password += Get-RandomCharacters -length 7 -characters '1234567890'",
                                        "$password += Get-RandomCharacters -length 5 -characters '!%&=?@#*+'",
                                        "$password = Scramble-String $password",
                                        "$USERNAME = 'Administrator'",
                                        "try {",
                                        "    #$password = $password | ConvertTo-SecureString -AsPlainText -Force",
                                        "    #New-LocalUser $USERNAME -Password $password -FullName 'golden_ami_user' -Description 'User account used by Golden AMI pipeline'",
                                        "    #Add-LocalGroupMember -Group 'Administrators' -Member $USERNAME",
                                        "    net user $USERNAME $password",
                                        "    Start-Sleep -s 120",
                                        "} catch {",
                                        "    Write-Host 'Some problem with user creation which resulted in error:'",
                                        "    Write-Host $_",
                                        "    Exit -1",
                                        "}",
                                        "try {",
                                        "    $templates=(Invoke-WebRequest -UseBasicParsing -Uri https://cloud.tenable.com/editor/policy/templates -Headers $headers) | ConvertFrom-Json",
                                        "    $uuid=(echo $templates | ConvertTo-Json | jq '.templates' | jq '.[] | select(.title==\\\"Basic Network Scan\\\")' | jq '.uuid')",
                                        "    $body = \"{\" + '\"uuid\"' + \":\" + $uuid + \",\" + '\"credentials\"' + \":\" + \"{\" + '\"add\"' + \":\" + \"{\" + '\"Host\"' + \":\" + \"{\" + '\"Windows\"' + \":\" + \"[{\" + '\"username\"' + \":\" + '\"' + $USERNAME + '\"' + \",\" + '\"password\"' + \":\" + '\"' + $password + '\"' + \",\" + '\"auth_method\"' + \":\" + '\"Password\"' + \"}]}}},\" + '\"settings\"' + \":\" + \"{\" + '\"name\"' + \":\" + '\"CandidateAMIScan-' + $AMI_ID + '-{{global:DATE_TIME}}\"' + \",\" + '\"text_targets\"' + \":\" + '\"{{createInstanceFromNewImage.InstanceIds}}\"' + \",\" + '\"scanner_id\"' + \":\" + $scanner_id + \",\" + '\"emails\"' + \":\" + '\"{{EmailID}}\"' + \",\" + '\"enabled\"' + \":\" + 0 + \"}}\"",
                                        "    $vm_scan_create_log_json = (Invoke-WebRequest -UseBasicParsing -H $headers -Body $body -Method POST -Uri https://cloud.tenable.com/scans).Content",
                                        "    echo $vm_scan_create_log_json >> vm-scan-create-log.json",
                                        "    $scan_id = (echo $vm_scan_create_log_json | jq '.scan' | jq '.id')",
                                        "    Invoke-WebRequest -UseBasicParsing -Headers $headers -Method POST -Uri https://cloud.tenable.com/scans/$scan_id/launch >> vm-scan-launch-log.json",
                                        "} catch {",
                                        "    Write-Host 'Process of lauching vulnerability assessment on tenable.io failed because of error:'",
                                        "    Write-Host $_",
                                        "    Exit -1",
                                        "}"
                                      ]
                                    },
                                    "InstanceIds": [
                                    "{{ createInstanceFromNewImage.InstanceIds }}"
                                    ],
                                    "DocumentName": "AWS-RunPowerShellScript"
                                },
                                "name": "LaunchtenableAssessment",
                                "action": "aws:runCommand",
                                "timeoutSeconds": 3600,
                                "onFailure": "Abort"
                               },
                               {
                                    "name": "waitForAssessment",
                                    "action": "aws:sleep",
                                    "inputs": {
                                       "Duration": "PT15M"
                                    }
                                },
                                {
                                    "name": "TagNewinstance",
                                    "action": "aws:createTags",
                                    "timeoutSeconds": 1200,
                                    "maxAttempts": 1,
                                    "onFailure": "Continue",
                                    "inputs": {
                                        "ResourceType": "EC2",
                                        "ResourceIds": [
                                           "{{ createInstanceFromNewImage.InstanceIds }}"
                                        ],
                                        "Tags": [
                                          {
                                              "Key": "Type",
                                              "Value": "{{createImage.ImageId}}-{{productOSAndVersion}}/{{productName}}/{{AMIVersion}}"
                                          },
                                          {
                                              "Key": "Automation-Instance-Type",
                                              "Value": "Golden"
                                          }
                                      ]
                                  }
                              },
                              {
                                  "name": "StoreVersion",
                                  "action": "aws:invokeLambdaFunction",
                                  "maxAttempts": 3,
                                  "timeoutSeconds": 120,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "FunctionName": { "Ref": "StoreVersionLambdaFunction"},
                                      "Payload": {
                                          "Fn::Join": [
                                              "",
                                              [
                                                  "{\"AMI-ID\": \"{{createImage.ImageId}}\",\"topicArn\":\"",
                                                  "\",\"instanceId\": \"{{ createInstanceFromNewImage.InstanceIds }}\",\"productOS\": \"{{productOSAndVersion}}\",\"productName\": \"{{productName}}\",\"productVersion\": \"{{AMIVersion}}\"}"
                                              ]
                                          ]
                                      }
                                  }
                              }, 
                              {
                                  "name": "sleep",
                                  "action": "aws:sleep",
                                  "inputs": {
                                      "Duration": "PT02M"
                                  }
                              },
                              {
                              "maxAttempts": 1,
                              "inputs": {
                                  "DesiredState": "terminated",
                                  "InstanceIds": [
                                    "{{ createInstanceFromNewImage.InstanceIds }}"
                                  ]
                              },
                              "name": "terminatetenableInstance",
                              "action": "aws:changeInstanceState",
                              "timeoutSeconds": 1200,
                              "onFailure": "Continue"
                              },
                              {
                                  "name": "addNewVersionParameter",
                                  "action": "aws:invokeLambdaFunction",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 1,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "FunctionName":{ "Ref": "AppendParamLambda"},
      
                                      "Payload": "{\"parameterName\":\"/GoldenAMI/{{productOSAndVersion}}/{{productName}}/{{AMIVersion}}\", \"valueToBeCreatedOrAppended\":\"{{createImage.ImageId}}\"}"
                                  }
                              },
                              {
                                  "name": "approve",
                                  "action": "aws:approve",
                                  "timeoutSeconds": 172800,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "NotificationArn": "{{ ApproverNotificationArn }}",
                                      "Message": "Please check your report from tenable, and decide whether to approve this AMI- {{createImage.ImageId}}",
                                      "MinRequiredApprovals": 1,
                                      "Approvers": [
                                          "{{ ApproverUserIAMARN1 }}",
                                          "{{ ApproverUserIAMARN2 }}",
                                          "{{ ApproverUserIAMARN3 }}"
                                      ]
                                  }
                              },
                              {
                                  "name": "updateLatestVersionValue",
                                  "action": "aws:invokeLambdaFunction",
                                  "timeoutSeconds": 1200,
                                  "maxAttempts": 1,
                                  "onFailure": "Abort",
                                  "inputs": {
                                      "FunctionName":{ "Ref": "AppendParamLambda"},
                                      "Payload": "{\"parameterName\":\"/GoldenAMI/latest\", \"valueToBeCreatedOrAppended\":\"{{createImage.ImageId}}\"}"
                                  }
                              }
                          ],
                          "outputs": [
                              "createImage.ImageId"
                          ]
                      }
                  }
              },
    
      "CopyToMultipleRegionsLambdaExecutionRole":{
               "Type":"AWS::IAM::Role",
               "Properties":{
                  "ManagedPolicyArns":[
                     "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                  ],
                  "AssumeRolePolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Principal":{
                              "Service":[
                                 "lambda.amazonaws.com"
                              ]
                           },
                            "Action":[
                              "sts:AssumeRole"
                           ]
                        }
                     ]
                  },
                  "Path":"/",
                  "Policies":[
                     {
                        "PolicyName":"CopyToMultipleRegionsLambdaExecutionPolicy",
                        "PolicyDocument":{
                           "Version":"2012-10-17",
                           "Statement":[
                              {
                                 "Effect":"Allow",
                                 "Action":["ssm:PutParameter","ssm:GetParameter"],
                                 "Resource":{ "Fn::Join":
                                  [
                                      "",
                                      [
                                          "arn:aws:ssm:", "*",
                                          ":",
                                          {
                                              "Ref":"AWS::AccountId"
                                          },
                                          ":parameter/GoldenAMI/*"
                                      ]
                                  ]}
                              },
                              {
                                  "Effect":"Allow",
                                  "Action":["ec2:CopyImage","ec2:DescribeImages"],
                                  "Resource": "*"
                              },
                              {
                                  "Effect":"Allow",
                                  "Action":["ec2:CreateTags"],
                                  "Resource": "*",
                                  "Condition": {
                                    "ForAllValues:StringEquals": {
                                      "aws:TagKeys": ["AMI-Type","ProductName","continuous-assessment-instance","ProductOSAndVersion","version","Copied_From:(owner-id/ami-id)"]
                                    }
                                  }
                              }
                           ]
                        }
                     }
                  ]
               }
            },

      "CopyToMultipleRegionsLambdaFunction":{
               "Type":"AWS::Lambda::Function",
               "Properties":{
                  "Role":{
                     "Fn::GetAtt":[
                        "CopyToMultipleRegionsLambdaExecutionRole",
                        "Arn"
                     ]
                  },
                  "Code":{
                     "ZipFile":{
                        "Fn::Join":[
                           "\n",
                           [
                              "import boto3",
                              "import json",
                              "from dateutil import parser",
                              "import dateutil",
                              "import datetime",
                              "import collections",
                              "import os",
                              "import botocore",
                              "def lambda_handler(event, context):",
                              "    sourceRegion = os.environ['AWS_DEFAULT_REGION']",
                              "    ssm = boto3.client('ssm',sourceRegion)",
                              "    allRegions = set();",
                              "    accountMetadata=json.loads(event['MetadataJSON'])",
                              "    metadataParamName=event['MetadataParamName']",
                              "    amiIDParamName=event['AmiIDParamName']",
                              "    AMIId =ssm.get_parameter(Name=amiIDParamName)['Parameter']['Value']",
                              "    ",
                              "    for accountID, regions in accountMetadata.items():",
                              "        regionList = regions.split(',')",
                              "        for region in regionList:",
                              "            allRegions.add(region)",
                              "    if sourceRegion in allRegions:",
                              "        allRegions.remove(sourceRegion)",
                              "    print(allRegions) ",
                              "    ec2Source =boto3.resource('ec2',sourceRegion)",
                              "    originalAMI = ec2Source.Image(AMIId)",
                              "    ownerId =originalAMI.owner_id",
                              "    ",
                              "    outputJson=\"{\"",
                              "    for region in allRegions: ",
                              "        ec2 = boto3.client('ec2',region)",
                              "        ec2Res  = boto3.resource('ec2',region)",
                              "        print (\"Copying Image {id} to {aws_region}\".format(aws_region=region, id=AMIId))",
                              "        new_ami = ec2.copy_image(",
                              "            DryRun=False,",
                              "            SourceRegion=sourceRegion,",
                              "            SourceImageId=AMIId,",
                              "            Name=\"copied from \"+originalAMI.name",
                              "        )  ",
                              "        copiedAMIId=new_ami['ImageId']",
                              "        ssm = boto3.client('ssm',region)",
                              "        ssm.put_parameter(Name=amiIDParamName,Value=copiedAMIId,Type='String',Overwrite=True)",
                              "        response = ec2.create_tags(Resources=[copiedAMIId],Tags=[{'Key': 'Copied_From:(owner-id/ami-id)', 'Value': ownerId+'/'+AMIId,}, {'Key': 'version', 'Value': event['version']}, {'Key': 'ProductOSAndVersion', 'Value': event['ProductOSAndVersion']}, {'Key': 'ProductName', 'Value': event['ProductName']}, {'Key': 'AMI-Type','Value':'Golden'}])",
                              "        outputJson+=\"\\\"\"+region+\"\\\":\"+\"\\\"\"+copiedAMIId+\"\\\",\"",
                              "        try:",
                              "            AMIIdsParam =ssm.get_parameter(Name='/GoldenAMI/latest')",
                              "            AMIIds=AMIIdsParam['Parameter']['Value']",
                              "            AMIIds= AMIIds+','+ copiedAMIId",
                              "            ssm.put_parameter(Name='/GoldenAMI/latest',Type='String', Value=AMIIds,Overwrite=True)",
                              "        except botocore.exceptions.ClientError as e:",
                              "            if e.response['Error']['Code'] == 'ParameterNotFound':",
                              "                ssm.put_parameter(Name='/GoldenAMI/latest',Type='String', Value=copiedAMIId,Overwrite=True)",
                              "    outputJson+=\"\\\"\"+sourceRegion+\"\\\":\"+\"\\\"\"+AMIId+\"\\\"}\"",
                              "    ssm = boto3.client('ssm',sourceRegion)",
                              "    print (\"Here is the output:\"+outputJson)",
                              "    ssm.put_parameter(Name=metadataParamName,Value=outputJson,Type='String',Overwrite=True)",
                              "    return 'Done';"
                           ]
                        ]
                     }
                  },
                  "Runtime":"python3.6",
                  "Timeout":300,
                  "Handler":"index.lambda_handler",
                  "MemorySize":512
               }
            },

      "CopyToMultipleAccountsLambdaExecutionRole":{
               "Type":"AWS::IAM::Role",
               "Properties":{
                  "ManagedPolicyArns":[
                     "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                  ],
                  "AssumeRolePolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Principal":{
                              "Service":[
                                 "lambda.amazonaws.com"
                              ]
                           },
                           "Action":[
                              "sts:AssumeRole"
                           ]
                        }
                     ]
                  },
                  "Path":"/",
                  "Policies":[
                     {
                        "PolicyName":"CopyToMultipleAccountsLambdaExecutionPolicy",
                        "PolicyDocument":{
                           "Version":"2012-10-17",
                           "Statement":[
                              {
                                 "Effect":"Allow",
                                 "Action":["ssm:GetParameter*","ssm:PutParameter*"],
                                 "Resource":{ "Fn::Join":
                                  [
                                      "",
                                      [
                                          "arn:aws:ssm:", "*",
                                          ":",
                                          {
                                              "Ref":"AWS::AccountId"
                                          },
                                          ":parameter/GoldenAMI/*"
                                      ]
                                  ]}
                              },
                              {
                                 "Effect":"Allow",
                                 "Action":["sts:AssumeRole"],
                                 "Resource": { "Fn::Join":
                                   [
                                     "",
                                     [
                                       "arn:aws:iam::*:role/",
                                       {
                                         "Ref":"roleName"
                                         }
                                         ]
                                        ]
                                      }
                              },

                              {
                                 "Effect":"Allow",
                                 "Action":["ec2:ModifyImageAttribute"],
                                 "Resource":"*"
                              }
                           ]
                        }
                     }
                  ]
               }
            },

      "CopyToMultipleAccountsLambdaFunction":{
               "Type":"AWS::Lambda::Function",
               "Properties":{
                  "Role":{
                     "Fn::GetAtt":[
                        "CopyToMultipleAccountsLambdaExecutionRole",
                        "Arn"
                     ]
                  },
                  "Code":{
                     "ZipFile":{
                        "Fn::Join":[
                           "",
                           [
                              "import boto3",
                              "\n","import json",
                              "\n","from dateutil import parser",
                              "\n","import dateutil",
                              "\n","import datetime",
                              "\n","import collections",
                              "\n","import os",
                              "\n","import botocore",
                              "\n","def lambda_handler(event, context):",
                              "\n","    ssm = boto3.client('ssm',os.environ['AWS_DEFAULT_REGION'])",
                              "\n","    accountMetadata=json.loads(event['MetadataJSON'])",
                              "\n","    amiRegionMappingParamName=event['MetadataParamName']",
                              "\n","    #Load the AMI-ID to region mapping in memory.",
                              "\n","    amiIDRegionMapping =  ssm.get_parameter(Name=amiRegionMappingParamName)['Parameter']['Value']",
                              "\n","    mappingJSON = json.loads(amiIDRegionMapping)",
                              "\n","    print(mappingJSON)",
                              "\n","    roleArnPrefix='arn:aws:iam::';",
                              "\n","    roleArnSuffix=':role/",{"Ref":"roleName"},"';",
                              "\n","    amiIDParamNameToCreate=event['AmiIDParamName'] ",
                              "\n","    # loop over account details.",
                              "\n","    ssm = boto3.client('ssm')",
                              "\n","    ssm.put_parameter(Name=amiIDParamNameToCreate+'/copyMetadata',Value=event['MetadataJSON'],Type='String',Overwrite=True)",
                              "\n","    SELF_ACCOUNT_ID = context.invoked_function_arn.split(':')[4]",
                              "\n","    for accountID, regions in accountMetadata.items():",
                              "\n","        if accountID != SELF_ACCOUNT_ID:",
                              "\n","            roleArn =roleArnPrefix+accountID+roleArnSuffix ",
                              "\n","            regionList = regions.split(',')",
                              "\n","            for region in regionList:",
                              "\n","                amiId=mappingJSON[region]",
                              "\n","                ec2Client = boto3.client('ec2',region)",
                              "\n","                ec2Client.modify_image_attribute(ImageId=amiId,LaunchPermission={'Add': [{ 'UserId': accountID }]},",
                              "\n","                OperationType='add', UserIds=[accountID],Value='string',DryRun=False)",
                              "\n","                sts_client = boto3.client('sts')",
                              "\n","                assumeRoleOutput = sts_client.assume_role(RoleArn=roleArn,RoleSessionName='AssumeRoleSession1');",
                              "\n","                credentials = assumeRoleOutput['Credentials']",
                              "\n","                ssm = boto3.client('ssm',region,",
                              "\n","                aws_access_key_id = credentials['AccessKeyId'],",
                              "\n","                aws_secret_access_key = credentials['SecretAccessKey'],",
                              "\n","                aws_session_token = credentials['SessionToken'])",
                              "\n","                try:",
                              "\n","                    AMIIdsParam =ssm.get_parameter(Name='/GoldenAMI/latest')",
                              "\n","                    AMIIds=AMIIdsParam['Parameter']['Value']",
                              "\n","                    AMIIds= AMIIds+','+ amiId",
                              "\n","                    ssm.put_parameter(Name='/GoldenAMI/latest',Type='String', Value=AMIIds,Overwrite=True)",
                              "\n","                except botocore.exceptions.ClientError as e:",
                              "\n","                    if e.response['Error']['Code'] == 'ParameterNotFound':",
                              "\n","                        ssm.put_parameter(Name='/GoldenAMI/latest',Type='String', Value=amiId,Overwrite=True)",
                              "\n","                response = ssm.put_parameter(Name=amiIDParamNameToCreate,Value=amiId,Type='String',Overwrite=True)",
                              "\n","    return 'Done'"
                           ]
                        ]
                     }
                  },
                  "Runtime":"python3.6",
                  "Timeout":300,
                  "Handler":"index.lambda_handler",
                  "MemorySize":512
               }
            },

      "CopyAndShareAMI":{
               "Type":"AWS::SSM::Document",
               "Properties":{
                  "DocumentType":"Automation",
                  "Content":{
                     "description":"This automation document triggers a workflow to copy and share the golden AMI with other regions/accounts",
                     "schemaVersion":"0.3",
                     "assumeRole":{
                              "Fn::GetAtt": [
                                  "AutomationServiceRole",
                                  "Arn"
                              ]
                          },
                     "parameters":{

                        "MetadataJSON":{
                           "type":"String",
                           "description":"This parameter contains details of accounts and regions with which AMI needs to be shared. Kindly do not change the structure of the JSON",
                           "default":{"Ref":"MetadataJSON"}
                        },
                        "bucketName":{
                           "type":"String",
                           "description":"This parameter contains name of the bucket in which template file is stored",
                           "default":{"Ref":"GoldenAMIConfigBucket"}
                         },
                        "templateFileName":{
                           "type":"String",
                           "description":"This parameter contains name of the template file",
                           "default":"simpleEC2-SSMParamInput.json"
                        },
                        "productName":{
                           "type":"String",
                           "description":"The syntax of this parameter is ProductName-ProductVersion",
                           "default":{ "Ref": "productName" }
                        },
                        "productOSAndVersion":{
                           "type":"String",
                           "description":"The syntax of this parameter is OSName-OSVersion",
                           "default":{ "Ref": "productOSAndVersion" }
                        },
                        "buildVersion":{
                           "type":"String",
                           "description":"This is the build number of the golden AMI to be distributed",
                           "default":{ "Ref": "buildVersion" }
                        },
                        "MetadataParamName":{
                           "type":"String",
                           "description":"This parameter points to an SSM parameter used for storing some process specific metadata. Kindly Do not change the default value.",
                           "default": "/GoldenAMI/{{productOSAndVersion}}/{{productName}}/{{buildVersion}}/temp"
                        }
                     },
                     "mainSteps":[
                        {
                           "name":"copyamitoregions",
                           "action":"aws:invokeLambdaFunction",
                           "timeoutSeconds":1200,
                           "maxAttempts":1,
                           "onFailure":"Abort",
                           "inputs":{
                              "FunctionName":{ "Ref": "CopyToMultipleRegionsLambdaFunction" },
                              "Payload":"{\"MetadataJSON\":\"{{ MetadataJSON }}\",\"ProductName\":\"{{ productName }}\",\"ProductOSAndVersion\":\"{{ productOSAndVersion }}\",\"version\":\"{{ buildVersion }}\",\"AmiIDParamName\":\"/GoldenAMI/{{productOSAndVersion}}/{{productName}}/{{buildVersion}}\", \"MetadataParamName\":\"{{ MetadataParamName }}\"}"
                           }
                        },
                        {
                           "name":"sleep",
                           "action":"aws:sleep",
                           "inputs":{
                              "Duration":"PT5M"
                           }
                        },
                        {
                           "name":"shareAmiWithAccounts",
                           "action":"aws:invokeLambdaFunction",
                           "timeoutSeconds":1200,
                           "maxAttempts":1,
                           "onFailure":"Abort",
                           "inputs":{
                              "FunctionName":{ "Ref": "CopyToMultipleAccountsLambdaFunction" },
                              "Payload":"{\"MetadataJSON\":\"{{ MetadataJSON }}\",\"AmiIDParamName\":\"/GoldenAMI/{{productOSAndVersion}}/{{productName}}/{{buildVersion}}\", \"MetadataParamName\":\"{{ MetadataParamName }}\"}"
                           }
                        },
                        {
                           "name":"publishToSC",
                           "action":"aws:invokeLambdaFunction",
                           "timeoutSeconds":1200,
                           "maxAttempts":1,
                           "onFailure":"Abort",
                           "inputs":{
                              "FunctionName":{ "Ref": "PublishAMILambda" },
                              "Payload":"{\"bucketName\":\"{{ bucketName }}\", \"amiRegionMappingParamName\":\"{{ MetadataParamName }}\", \"templateFileName\":\"{{templateFileName}}\", \"versionToBeCreated\":\"{{ buildVersion }}\", \"productOSAndVersion\":\"{{ productOSAndVersion }}\", \"productNameAndVersion\":\"{{ productName }}\"}"
                           }
                        }
                     ],
                     "outputs":[
                        "shareAmiWithAccounts.LogResult",
                        "copyamitoregions.LogResult"
                     ]
                  }
               }
            },

      "DecommissionAMIVersion":{
               "Type":"AWS::SSM::Document",
               "Properties":{
                  "DocumentType":"Automation",
                  "Content":{
                     "description":"This automation document triggers golden AMI build decommissioning workflow",
                     "schemaVersion":"0.3",
                     "assumeRole":{
                              "Fn::GetAtt": [
                                  "AutomationServiceRole",
                                  "Arn"
                              ]
                          },
                     "parameters":{

                        "bucketName":{
                           "type":"String",
                           "description":"This parameter contains name of the bucket in which CFT template file is stored",
                           "default":{"Ref":"GoldenAMIConfigBucket"}
                        },
                        "templateFileName":{
                           "type":"String",
                           "description":"The CFT template file-name used for creating the Service Catalog product",
                           "default":"simpleEC2-SSMParamInput.json"
                        },
                        "productName":{
                           "type":"String",
                           "description":"The syntax of this parameter is ProductName-ProductVersion",
                           "default":{ "Ref": "productName" }
                        },
                        "productOSAndVersion":{
                           "type":"String",
                           "description":"The syntax of this parameter is OSName-OSVersion",
                           "default":{ "Ref": "productOSAndVersion" }
                        },
                        "buildVersion":{
                           "type":"String",
                           "description":"Golden AMI build number to be decommissioned.",
                           "default":{ "Ref": "buildVersion" }
                        },
                        "MetadataParamName":{
                           "type":"String",
                           "description":"This parameter points to an SSM parameter used for storing some process specific metadata. Do not change the default value.",
                           "default": "/GoldenAMI/{{productOSAndVersion}}/{{productName}}/{{buildVersion}}/temp"
                        }
                     },
                     "mainSteps":[
                        {
                           "name":"DecommissionAMIVersionLambda",
                           "action":"aws:invokeLambdaFunction",
                           "timeoutSeconds":1200,
                           "maxAttempts":1,
                           "onFailure":"Abort",
                           "inputs":{
                              "FunctionName":{ "Ref": "DecommissionAMIVersionLambda"},
                              "Payload":"{\"bucketName\":\"{{ bucketName }}\", \"amiRegionMappingParamName\":\"{{ MetadataParamName }}\", \"templateFileName\":\"{{templateFileName}}\", \"versionToBeDeleted\":\"{{ buildVersion }}\", \"productOSAndVersion\":\"{{ productOSAndVersion }}\", \"productNameAndVersion\":\"{{ productName }}\"}"
                           }
                        },
                       {
                           "name":"DecommissionAMIVersionFromAccountsLambda",
                           "action":"aws:invokeLambdaFunction",
                           "timeoutSeconds":1200,
                           "maxAttempts":1,
                           "onFailure":"Abort",
                           "inputs":{
                              "FunctionName":{ "Ref": "DecommissionAMIVersionFromAccountsLambda"},
                              "Payload":"{\"bucketName\":\"{{ bucketName }}\", \"amiRegionMappingParamName\":\"{{ MetadataParamName }}\", \"templateFileName\":\"{{templateFileName}}\", \"versionToBeDeleted\":\"{{ buildVersion }}\", \"productOSAndVersion\":\"{{ productOSAndVersion }}\", \"productNameAndVersion\":\"{{ productName }}\"}"
                           }
                        }

                     ]
                  }
               }
            },

      "RunLinuxContinuousInspection":{
               "Type":"AWS::SSM::Document",
               "Properties":{
                  "DocumentType":"Automation",
                  "Content":{
                     "description":"This automation document is triggered as part of the continuous vulnerability assessment on Linux based active golden AMIs.",
                     "schemaVersion":"0.3",
                     "assumeRole":{
                              "Fn::GetAtt": [
                                  "AutomationServiceRole",
                                  "Arn"
                              ]
                          },
                          "parameters": {
                                "instanceIDs": {
                                  "description": "This parameter contains list of instance-ids on which continuous vulnerability assessment is  performed.",
                                  "type": "String"
                                },
                                "tenableApiKey": {
                                  "default": "/GoldenAMI/tenable/tenableApiKey",
                                  "description": "SSM parameter name of tenable username to access API",
                                  "type": "String"
                                },

                                "tenableSecretKey": {
                                  "default": "/GoldenAMI/tenable/tenableSecretKey",
                                  "description": "SSM parameter name of the tenable password to access API",
                                  "type": "String"
                                },
                                "tenableScanType": {
                                  "default": "{{ssm:/GoldenAMI/tenable/tenableScanType}}",
                                  "description": "SSM parameter name of tenable SCAN TYPE to start scan to access API",
                                  "type": "String"
                                },

                                "tenableScannerName": {
                                  "default": "{{ssm:/GoldenAMI/tenable/tenableScannerName}}",
                                  "description": "SSM parameter name of the tenable scanner to launch VM scan",
                                  "type": "String"
                                },

                                "tenableApiUrl": {
                                  "type": "String",
                                  "description": "Your tenable URL for accessing API",
                                  "default": {
                                    "Ref":"tenableApiUrl"
                                  }
                                },

                                "EmailID": {
                                "type": "String",
                                "description": "Email ID of the admin who will receive scan assessment reports from Tenable",
                                "default": {
                                    "Ref": "EmailID"
                                }
                              }
                              },

                     "mainSteps":[
                        {
                           "name":"waitForInstance",
                           "action":"aws:sleep",
                           "inputs":{
                              "Duration":"PT10M"
                           }
                         },
                         {
                          "maxAttempts": 1,
                          "inputs": {
                            "Parameters": {
                              "commands": [
                                "set -e",
                                "sudo su",
                                "if cat /etc/*release | grep ^NAME | grep Amazon; then",
                                  "yum install -y jq",
                                  "yum install -y awscli",
                                  "if getent passwd | grep ec2-user; then",
                                  "USERNAME=\"ec2-user\"",
                                  "else",
                                  "echo \"Error: ec2-user not found\"",
                                  "fi",
                                "elif cat /etc/*release | grep ^NAME | grep CentOS; then",
                                  "yum install -y jq",
                                  "yum install -y awscli",
                                  "if getent passwd | grep centos; then",
                                  "USERNAME=\"centos\"",
                                  "elif getent passwd| grep ec2-user; then",
                                  "USERNAME=\"ec2-user\"",
                                  "fi",
                                "elif cat /etc/*release | grep ^NAME | grep Red; then",
                                  "yum install -y jq",
                                  "yum install -y awscli",
                                  "if getent passwd | grep root; then",
                                  "USERNAME=\"root\"",
                                  "elif getent passwd | grep ec2-user; then",
                                  "USERNAME=\"ec2-user\"",
                                  "fi",
                                "elif cat /etc/*release | grep ^NAME | grep Fedora; then",
                                  "yum install -y jq",
                                  "yum install -y awscli",
                                  "if getent passwd | grep fedora; then",
                                  "USERNAME=\"fedora\"",
                                  "elif getent passwd | grep ec2-user; then",
                                  "USERNAME=\"ec2-user\"",
                                  "fi",
                                "elif cat /etc/*release | grep ^NAME | grep Ubuntu; then",
                                  "apt-get update",
                                  "apt-get install -y jq",
                                  "apt-get install -y awscli",
                                  "if getent passwd | grep ubuntu; then",
                                  "USERNAME=\"ubuntu\"",
                                  "elif getent passwd | grep ec2-user; then",
                                  "USERNAME=\"ec2-user\"",
                                  "fi",
                                "elif cat /etc/*release | grep ^NAME | grep Debian ; then",
                                  "apt-get update",
                                  "apt-get install -y jq",
                                  "apt-get install -y awscli",
                                  "if getent passwd | grep admin; then",
                                  "USERNAME=\"admin\"",
                                  "elif getent passwd | grep ec2-user; then",
                                  "USERNAME=\"ec2-user\"",
                                  "fi",
                                "else",
                                  "echo \"OS not supported\"",
                                  "exit 1;",
                                "fi",
                                "REGION=\"{{global:REGION}}\"",
                                "AMI_ID=$(curl -s 'http://169.254.169.254/latest/meta-data/ami-id')",
                                "host_name=$(hostname -s)",
                                "keyname=tenable-key-$host_name-{{global:DATE_TIME}}",
                                "accessKey=$(aws ssm get-parameter --with-decryption --region $REGION --name {{tenableApiKey}} --query 'Parameter.Value' --output text)",
                                "secretKey=$(aws ssm get-parameter --with-decryption --region $REGION --name {{tenableSecretKey}} --query 'Parameter.Value' --output text)",
                                "list=$(curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" https://cloud.tenable.com/scanners/)",
                                "scanner_id=$(echo $list | jq '.scanners' | jq '.[] | select(.name==\"{{tenableScannerName}}\")' | jq '.id')",
                                "SSHDIR=$(pwd)",
                                "if [ -d \"/home/$USERNAME/.ssh\" ]; then",
                                  "if [ -d \"$SSHDIR/.ssh\" ]; then",
                                    "echo \"$SSHDIR/.ssh directory exists\"",
                                  "else",
                                    "echo \"$SSHDIR/.ssh directory does not exist hence creating it\"",
                                    "sudo mkdir $SSHDIR/.ssh",
                                  "fi",
                                  "echo \".ssh directory exists in user's home\"",
                                "else",
                                  "echo \".ssh directory does not exist in user's home hence creating it\"",
                                  "sudo mkdir /home/$USERNAME/.ssh",
                                "fi",
                                "ssh-keygen -m PEM -t rsa -C $keyname -f $SSHDIR/.ssh/$keyname.pem -q -N ''",
                                "cat $SSHDIR/.ssh/$keyname.pem.pub >> /home/$USERNAME/.ssh/authorized_keys",
                                "echo \"setting permissions on key\"",
                                "chmod 0400 $SSHDIR/.ssh/$keyname.pem",
                                "aws ec2 import-key-pair --region $REGION --key-name $keyname --public-key-material file://$SSHDIR/.ssh/$keyname.pem.pub",
                                "service sshd restart",
                                "cd $SSHDIR/.ssh",
                                "curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" -H \"Accept: application/json\" -H \"Content-Type: multipart/form-data\" -F \"Filedata=@$keyname.pem\" -X POST https://cloud.tenable.com/file/upload>vm-key-upload-log.txt",
                                "sleep 2m",
                                "templates=$(curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" https://cloud.tenable.com/editor/policy/templates)",
                                "uuid=$(echo $templates | jq '.templates' | jq '.[] | select(.title==\"{{tenableScanType}}\")' | jq '.uuid')",
                                "curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" -H \"Content-Type: application/json\" -d '{\"uuid\": '$uuid',\"credentials\":{\"add\":{\"Host\":{\"SSH\":[{\"private_key\":\"'$keyname'.pem\",\"username\":\"'$USERNAME'\",\"auth_method\":\"public key\"}]}}}, \"settings\":{\"name\":\"CandidateAMIScan-'$AMI_ID'-{{global:DATE_TIME}}\", \"text_targets\":\"{{instanceIDs}}\",\"scanner_id\":'$scanner_id',\"emails\":\"{{EmailID}}\", \"enabled\":'true'}}' -X POST https://cloud.tenable.com/scans>vm-scan-create-log.json",
                                "scan_id=$(jq . vm-scan-create-log.json | jq .'scan' | jq .'id')",
                                "curl -H \"X-ApiKeys: accessKey=$accessKey; secretKey=$secretKey\" -H \"Content-Type: application/json\" -X POST https://cloud.tenable.com/scans/$scan_id/launch>vm-scan-launch-log.json"
                                ]
                            },
                            "InstanceIds": [
                              "{{instanceIDs}}"
                            ],
                            "DocumentName": "AWS-RunShellScript"
                          },
                          "name": "LaunchtenableAssessment",
                          "action": "aws:runCommand",
                          "timeoutSeconds": 3600,
                          "onFailure": "Abort"
                        },
                        {
                           "name":"waitForAssessment",
                           "action":"aws:sleep",
                           "inputs":{
                              "Duration":"PT15M"
                           }
                         },
                         {
                            "maxAttempts": 1,
                            "inputs": {
                                "Parameters": {
                                    "commands": [
                                        "REGION=\"{{global:REGION}}\"",
                                        "SSHDIR=$(pwd)",
                                        "keyname=$(basename -- $(find $SSHDIR/.ssh -type f -iname \"tenable-key-*.pem\"))",
                                        "keyname=$(echo ${keyname%.pem})",
                                        "echo 'Deleting key pair'",
                                        "aws ec2 delete-key-pair --region $REGION --key-name $keyname"
                                    ]
                                },
                                "InstanceIds": [
                                   "{{instanceIDs}}"
                                ],
                                "DocumentName": "AWS-RunShellScript"
                            },
                            "name": "DeleteKeyPair",
                            "action": "aws:runCommand",
                            "timeoutSeconds": 3600,
                            "onFailure": "Abort"
                         },
                         {
                             "name": "terminateAssessmentInstance",
                             "action": "aws:changeInstanceState",
                             "timeoutSeconds": 1200,
                             "maxAttempts": 1,
                             "onFailure": "Continue",
                             "inputs": {
                                 "InstanceIds": [
                                     "{{instanceIDs}}"
                                 ],
                                 "DesiredState": "terminated"
                             }
                         }
                     ]
                  }
               }
            },

      "RunWindowsContinuousInspection":{
                "Type":"AWS::SSM::Document",
                "Properties":{
                   "DocumentType":"Automation",
                   "Content":{
                      "description":"This automation document is triggered as part of the continuous vulnerability assessment on all Windows based active golden AMIs.",
                      "schemaVersion":"0.3",
                      "assumeRole":{
                               "Fn::GetAtt": [
                                   "AutomationServiceRole",
                                   "Arn"
                               ]
                           },
                           "parameters": {
                                 "instanceIDs": {
                                   "description": "This parameter contains list of instance-ids on which continuous vulnerability assessment is  performed.",
                                   "type": "String"
                                 },
                                 "tenableApiKey": {
                                   "default": "/GoldenAMI/tenable/tenableApiKey",
                                   "description": "SSM parameter name of tenable username to access API",
                                   "type": "String"
                                 },
 
                                 "tenableSecretKey": {
                                   "default": "/GoldenAMI/tenable/tenableSecretKey",
                                   "description": "SSM parameter name of the tenable password to access API",
                                   "type": "String"
                                 },
                                 "tenableScanType": {
                                   "default": "{{ssm:/GoldenAMI/tenable/tenableScanType}}",
                                   "description": "SSM parameter name of tenable SCAN TYPE to start scan to access API",
                                   "type": "String"
                                 },
 
                                 "tenableScannerName": {
                                   "default": "{{ssm:/GoldenAMI/tenable/tenableScannerName}}",
                                   "description": "SSM parameter name of the tenable scanner to launch VM scan",
                                   "type": "String"
                                 },
 
                                 "tenableApiUrl": {
                                   "type": "String",
                                   "description": "Your tenable URL for accessing API",
                                   "default": {
                                     "Ref":"tenableApiUrl"
                                   }
                                 },
 
                                 "EmailID": {
                                 "type": "String",
                                 "description": "Email ID of the admin who will receive scan assessment reports from Tenable",
                                 "default": {
                                     "Ref": "EmailID"
                                 }
                               }
                               },
 
                      "mainSteps":[
                         {
                            "name":"waitForInstance",
                            "action":"aws:sleep",
                            "inputs":{
                               "Duration":"PT10M"
                            }
                          },
                          {
                            "maxAttempts": 1,
                            "inputs": {
                              "Parameters": {
                              "commands": [
                                  "$ie = Start-Process -file iexplore -arg 'http://www.google.com' -PassThru",
                                  "Start-Sleep -s 5",
                                  "$ie.Kill()",
                                  "try{",
                                  "    Set-ExecutionPolicy AllSigned",
                                  "} catch {",
                                  "    Write-Host 'Warning:'",
                                  "    Write-Host $_",
                                  "}",
                                  "try {",
                                  "    $chocolatey_path = 'C:\\ProgramData\\chocolatey'",
                                  "    if(Test-Path -Path $chocolatey_path) {",
                                  "        try {",
                                  "            $testchoco = (choco -v)",
                                  "            if(-not($testchoco)) {",
                                  "                Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))",
                                  "            }",
                                  "            else {",
                                  "                Write-Host 'Seems like chocolatey is already installed'",
                                  "                }",
                                  "        } catch {",
                                  "            Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))",
                                  "        }",
                                  "    }",
                                  "    else {",
                                  "        Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))",
                                  "    }",
                                  "} catch {",
                                  "    Write-Host 'Chocolatey installation failed because of following error:'",
                                  "    Write-Host $_",
                                  "    Exit -1",
                                  "}",
                                  "try {",
                                  "    [int]$OsVersion = ((Get-ComputerInfo | select OsVersion).OsVersion).split('.')[0]",
                                  "    if ($OsVersion -ge 8) {",
                                  "        $smb_status = (Get-SmbServerConfiguration | Select EnableSMB2Protocol).EnableSMB2Protocol",
                                  "        $remote_registry = (Get-CimInstance -Class Win32_Service -Filter 'Name = \"RemoteRegistry\"').State",
                                  "        if ($smb_status -eq $false) {",
                                  "            Write-Host 'smb service is disabled, enabling it'",
                                  "            Set-SmbServerConfiguration -EnableSMB2Protocol $true -Force",
                                  "        }",
                                  "        if ($smb_status -eq $true) {",
                                  "            Write-Host 'smb service is enabled, moving on'",
                                  "        }",
                                  "        if ($remote_registry -like '*isabled') {",
                                  "            Write-Host 'remote registry service is disabled, enabling it'",
                                  "            Set-Service -Name RemoteRegistry -StartupType Automatic",
                                  "        }",
                                  "        if ($remote_registry -like '*nabled') {",
                                  "            Write-Host 'remote registry service is enabled'",
                                  "        }",
                                  "        if ($remote_registry -like '*topped') {",
                                  "            Write-Host 'remote registry service is stopped, starting it'",
                                  "            Start-Service -InputObject (Get-Service -Name RemoteRegistry)",
                                  "        }",
                                  "        if ($remote_registry -like '*unning') {",
                                  "            Write-Host 'remote registry service is running, moving on'",
                                  "        }",
                                  "    }",
                                  "    else {",
                                  "        $smb_status = (Get-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters | ForEach-Object {Get-ItemProperty $_.pspath}).State",
                                  "        if ($smb_status -like '*isabled') {",
                                  "            Write-Host 'smb service is disabled, enabling it'",
                                  "            Set-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Parameters\" SMB2 -Type DWORD -Value 1 -Force",
                                  "         }",
                                  "        else {",
                                  "          Write-Host 'smb service is enabled, moving on'",
                                  "         }",
                                  "    }",
                                  "} catch {",
                                  "      Write-Host 'Some problem with smb status check, error:'",
                                  "      Write-Host $_",
                                  "      Exit -1",
                                  "}",
                                  "try{",
                                  "    shutdown -r",
                                  "} catch {",
                                  "    Write-Host 'Unable to reboot the system, error:'",
                                  "    Write-Host $_",
                                  "    Exit -1",
                                  "}"
                                ]
                              },
                              "InstanceIds": [
                                "{{ instanceIDs }}"
                              ],
                              "DocumentName": "AWS-RunPowerShellScript"
                            },
                            "name": "PrepForScan",
                            "action": "aws:runCommand",
                            "timeoutSeconds": 3600,
                            "onFailure": "Abort"
                          },
                          {
                            "name": "waitAfterInstanceRestart",
                            "action": "aws:sleep",
                            "inputs": {
                              "Duration": "PT5M"
                              }
                          },
                          {
                              "maxAttempts": 1,
                              "inputs": {
                                "Parameters": {
                                "commands": [
                                    "$ie = Start-Process -file iexplore -arg 'http://www.google.com' -PassThru",
                                    "Start-Sleep -s 5",
                                    "$ie.Kill()",
                                    "try {",
                                    "     Write-Host 'Disabling firewall for running the scan'",
                                    "     netsh advfirewall set allprofiles state off",
                                    "     Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False",
                                    "} catch {",
                                    "    Write-Host 'There was an error while disabling the firewall:'",
                                    "    Write-Host $_",
                                    "    Exit -1",
                                    "}",
                                    "try {",
                                    "    choco upgrade chocolatey",
                                    "    chocolatey install jq -y --force",
                                    "} catch {",
                                    "    Write-Host 'Unable to upgrade chocolatey, error:'",
                                    "    Write-Host $_",
                                    "    Exit -1",
                                    "}",
                                    "$REGION=\"{{global:REGION}}\"",
                                    "$AMI_ID=(Invoke-WebRequest -UseBasicParsing http://169.254.169.254/latest/meta-data/ami-id).Content",
                                    "$accessKey=(Get-SSMParameter -WithDecryption 1 -Region $REGION -Name /GoldenAMI/tenable/tenableApiKey).Value",
                                    "$secretKey=(Get-SSMParameter -WithDecryption 1 -Region $REGION -Name /GoldenAMI/tenable/tenableSecretKey).Value",
                                    "$headers=@{}",
                                    "$headers.Add(\"Accept\", \"application/json\")",
                                    "$headers.Add(\"Content-Type\", \"application/json\")",
                                    "$headers.Add(\"X-ApiKeys\", \"accessKey= $accessKey;secretKey= $secretKey\")",
                                    "$list=(Invoke-WebRequest -UseBasicParsing -Uri https://cloud.tenable.com/scanners/ -Headers $headers) | ConvertFrom-Json",
                                    "$scanner_id=(echo $list | ConvertTo-Json | jq '.scanners' | jq '.[] | select(.name==\\\"Nessus-Scanner\\\")' | jq '.id')",
                                    "function Get-RandomCharacters($length, $characters)",
                                    "{",
                                    "    try {",
                                    "        $random = 1..$length | ForEach-Object { Get-Random -Maximum $characters.length }",
                                    "        $private:ofs=''",
                                    "        return [String]$characters[$random]",
                                    "    } catch {",
                                    "        Write-Host 'Unable to generate randome string, error:'",
                                    "        Write-Host $_",
                                    "    }",
                                    "}",
                                    "function Scramble-String([string]$inputString)",
                                    "{",
                                    "    try {",
                                    "        $characterArray = $inputString.ToCharArray()",
                                    "        $scrambledStringArray = $characterArray | Get-Random -Count $characterArray.Length",
                                    "        $outputString = -join $scrambledStringArray",
                                    "        return $outputString",
                                    "    } catch {",
                                    "        Write-Host 'Unable to scramble string for the given random string, error:'",
                                    "        Write-Host $_",
                                    "    }",
                                    "}",
                                    "$password = Get-RandomCharacters -length 10 -characters 'abcdefghiklmnoprstuvwxyz'",
                                    "$password += Get-RandomCharacters -length 10 -characters 'ABCDEFGHKLMNOPRSTUVWXYZ'",
                                    "$password += Get-RandomCharacters -length 7 -characters '1234567890'",
                                    "$password += Get-RandomCharacters -length 5 -characters '!%&=?@#*+'",
                                    "$password = Scramble-String $password",
                                    "$USERNAME = 'golden_ami'",
                                    "try {",
                                    "    #$password = $password | ConvertTo-SecureString -AsPlainText -Force",
                                    "    #New-LocalUser $USERNAME -Password $password -FullName 'golden_ami_user' -Description 'User account used by Golden AMI pipeline'",
                                    "    #Add-LocalGroupMember -Group 'Administrators' -Member $USERNAME",
                                    "    net user $USERNAME $password",
                                    "    Start-Sleep -s 120",
                                    "} catch {",
                                    "    Write-Host 'Some problem with user creation which resulted in error:'",
                                    "    Write-Host $_",
                                    "    Exit -1",
                                    "}",
                                    "try {",
                                    "    $templates=(Invoke-WebRequest -UseBasicParsing -Uri https://cloud.tenable.com/editor/policy/templates -Headers $headers) | ConvertFrom-Json",
                                    "    $uuid=(echo $templates | ConvertTo-Json | jq '.templates' | jq '.[] | select(.title==\\\"Basic Network Scan\\\")' | jq '.uuid')",
                                    "    $body = \"{\" + '\"uuid\"' + \":\" + $uuid + \",\" + '\"credentials\"' + \":\" + \"{\" + '\"add\"' + \":\" + \"{\" + '\"Host\"' + \":\" + \"{\" + '\"Windows\"' + \":\" + \"[{\" + '\"username\"' + \":\" + '\"' + $USERNAME + '\"' + \",\" + '\"password\"' + \":\" + '\"' + $password + '\"' + \",\" + '\"auth_method\"' + \":\" + '\"Password\"' + \"}]}}},\" + '\"settings\"' + \":\" + \"{\" + '\"name\"' + \":\" + '\"CandidateAMIScan-' + $AMI_ID + '-{{global:DATE_TIME}}\"' + \",\" + '\"text_targets\"' + \":\" + '\"{{instanceIDs}}\"' + \",\" + '\"scanner_id\"' + \":\" + $scanner_id + \",\" + '\"emails\"' + \":\" + '\"{{EmailID}}\"' + \",\" + '\"enabled\"' + \":\" + 0 + \"}}\"",
                                    "    $vm_scan_create_log_json = (Invoke-WebRequest -UseBasicParsing -H $headers -Body $body -Method POST -Uri https://cloud.tenable.com/scans).Content",
                                    "    echo $vm_scan_create_log_json >> vm-scan-create-log.json",
                                    "    $scan_id = (echo $vm_scan_create_log_json | jq '.scan' | jq '.id')",
                                    "    Invoke-WebRequest -UseBasicParsing -Headers $headers -Method POST -Uri https://cloud.tenable.com/scans/$scan_id/launch >> vm-scan-launch-log.json",
                                    "} catch {",
                                    "    Write-Host 'Process of lauching vulnerability assessment on tenable.io failed because of error:'",
                                    "    Write-Host $_",
                                    "    Exit -1",
                                    "}"
                                  ]
                                },
                                "InstanceIds": [
                                    "{{ instanceIDs }}"
                                ],
                                "DocumentName": "AWS-RunPowerShellScript"
                              },
                              "name": "LaunchtenableAssessment",
                              "action": "aws:runCommand",
                              "timeoutSeconds": 3600,
                              "onFailure": "Abort"
                            },
                            {
                              "name":"waitForAssessment",
                              "action":"aws:sleep",
                              "inputs":{
                                 "Duration":"PT15M"
                              }
                            },
                            {
                              "name": "terminateAssessmentInstance",
                              "action": "aws:changeInstanceState",
                              "timeoutSeconds": 1200,
                              "maxAttempts": 1,
                              "onFailure": "Continue",
                              "inputs": {
                                  "InstanceIds": [
                                      "{{instanceIDs}}"
                                  ],
                                  "DesiredState": "terminated"
                              }
                            }
                        ]
                     }
                  }
               },

      "ScheduledRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
              "Description": "ScheduledRule",
              "ScheduleExpression": {"Ref":"continuousInspectionFrequency"},
              "State": "ENABLED",
              "Targets": [{
                "Arn": { "Fn::GetAtt": ["SetupContinuousAssessmentLambdaFunction", "Arn"] },
                "Id": "TargetFunctionV1",
                "Input" :
                      {"Fn::Join":
                        [
                          "",
                      [
                       "{\"AMIsParamName\":\"/GoldenAMI/",

                               "latest",
                               "\", \"instanceType\":\"",
                               {"Ref":"instanceType"},
                        "\",\"tenableUserParamName\":\"/GoldenAMI/tenable/tenableApiKey",
                        "\",\"tenableSecretKeyParamName\":\"/GoldenAMI/tenable/tenableSecretKey",
                        "\",\"tenableScannerParamName\":\"/GoldenAMI/tenable/tenableScannerName",
                        "\",\"tenableApiUrlParamName\":\"",
                          {"Ref":"tenableApiUrl"},
                        "\",\"tenableScanTypeParamName\":\"/GoldenAMI/tenable/tenableScanType",
                               "\"}"
                        ]
                     ]
                  }
              }]
            }
        },

      "PermissionForEventsToInvokeLambda": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
              "FunctionName": { "Ref": "SetupContinuousAssessmentLambdaFunction" },
              "Action": "lambda:InvokeFunction",
              "Principal": "events.amazonaws.com",
              "SourceArn": { "Fn::GetAtt": ["ScheduledRule", "Arn"] }
            }
          },

      "StartContinuousAssessmentLambdaRole":{
               "Type":"AWS::IAM::Role",
               "Properties":{
                  "ManagedPolicyArns":[
                     "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                  ],
                  "AssumeRolePolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Principal":{
                              "Service":[
                                 "lambda.amazonaws.com"
                              ]
                           },
                           "Action":[
                              "sts:AssumeRole"
                           ]
                        }
                     ]
                  },
                  "Path":"/",
                  "Policies":[
                     {
                        "PolicyName":"StartContinuousAssessmentLambdaPolicy",
                        "PolicyDocument":{
                           "Version":"2012-10-17",
                           "Statement":[{
                           "Sid": "StartContinuousAssessmentLambdaPolicyStmt",
                           "Effect": "Allow",
                           "Action":["ssm:GetParameter"],
                           "Resource": [{ "Fn::Join":
                                  [
                                      "",
                                      [
                                          "arn:aws:ssm:", "*",
                                          ":",
                                          {
                                              "Ref":"AWS::AccountId"
                                          },
                                          ":parameter/GoldenAMI/*"
                                      ]
                                  ]} ]
                           }]
                        }
                     },
                       {
                        "PolicyName":"StartContinuousAssessmentLambdaPolicy2",
                        "PolicyDocument":{
                           "Version":"2012-10-17",
                           "Statement":[
                           {
                           "Sid": "StartContinuousAssessmentLambdaPolicyStmt2",
                           "Effect": "Allow",
                           "Action":[
                             "ec2:DescribeImages"
                            ],
                           "Resource": ["*"]
                           },
                           {
                            "Effect": "Allow",
                           "Action":"iam:PassRole",
                           "Resource":[{"Fn::GetAtt" : ["ManagedInstanceRole", "Arn"] }]
                            },
                             {
                           "Effect": "Allow",
                           "Action":"ssm:StartAutomationExecution",
                           "Resource":
                           {
                            "Fn::Join": [
                                  "",
                                  [
                                      "arn:aws:ssm:", {"Ref":"AWS::Region" },":", {"Ref":"AWS::AccountId"},":automation-definition/",{"Ref": "RunLinuxContinuousInspection"},":*"
                                  ]
                                  ]
                                }
                                },
                              {
                                  "Effect":"Allow",
                                  "Action":["ec2:CopyImage","ec2:DescribeImages","ec2:DescribeInstances"],
                                  "Resource": "*"
                              },
                              {
                                  "Effect":"Allow",
                                  "Action":["ec2:createTags"],
                                  "Resource": "*",
                                  "Condition": {
                                    "ForAllValues:StringEquals": {
                                      "aws:TagKeys": ["AMI-Type","ProductName","continuous-assessment-instance","ProductOSAndVersion","version"]
                                    }
                                  }
                              },
                              {
                                  "Effect":"Allow",
                                  "Action":["ec2:AssociateIamInstanceProfile"],
                                  "Resource":  [{"Fn::GetAtt" : ["ManagedInstanceProfile", "Arn"] }]
                              },
                                {
                                  "Effect": "Allow",
                                  "Action": "ec2:RunInstances",
                                  "Resource": [
                                      { "Fn::Join": ["",["arn:aws:ec2:", {"Ref":"AWS::Region" },"::image/ami-*"]]}
                                  ],
                                  "Condition": {
                                      "StringEquals": {
                                          "ec2:ResourceTag/AMI-Type": "Golden"
                                      }
                                  }
                              },
                              {
                                "Effect": "Allow",
                                "Action": "ec2:RunInstances",
                                "Resource": [
                                { "Fn::Join": ["",["arn:aws:ec2:", {"Ref":"AWS::Region" },":", {"Ref":"AWS::AccountId"},":instance/*"]]},
                                { "Fn::Join": ["",["arn:aws:ec2:", {"Ref":"AWS::Region" },":", {"Ref":"AWS::AccountId"},":subnet/*"]]},
                                { "Fn::Join": ["",["arn:aws:ec2:", {"Ref":"AWS::Region" },":", {"Ref":"AWS::AccountId"},":volume/*"]]},
                                { "Fn::Join": ["",["arn:aws:ec2:", {"Ref":"AWS::Region" },":", {"Ref":"AWS::AccountId"},":network-interface/*"]]},
                                { "Fn::Join": ["",["arn:aws:ec2:", {"Ref":"AWS::Region" },":", {"Ref":"AWS::AccountId"},":key-pair/*"]]},
                                { "Fn::Join": ["",["arn:aws:ec2:", {"Ref":"AWS::Region" },":", {"Ref":"AWS::AccountId"},":security-group/*"]]}
                                ]
                            }
                           ]
                        }
                     }
                  ]
               }
            },

      "SetupContinuousAssessmentLambdaFunction":{
               "Type":"AWS::Lambda::Function",
               "Properties":{
                  "Role":{
                     "Fn::GetAtt":[
                        "StartContinuousAssessmentLambdaRole",
                        "Arn"
                     ]
                  },
                  "Code":{
                     "ZipFile":{
                        "Fn::Join":[
                           "",
                           [
                        "\n","import json",
                        "\n","import urllib.parse",
                        "\n","import boto3",
                        "\n","import time",
                        "\n","import os",
                        "\n","def lambda_handler(event, context):",
                        "\n","    region=os.environ['AWS_DEFAULT_REGION']",
                        "\n","    ec2 = boto3.client('ec2',region)",
                        "\n","    ssm = boto3.client('ssm',region)",
                        "\n","    amisParamName = event['AMIsParamName'];",
                        "\n","    tenableApiKey = event['tenableUserParamName'];",
                        "\n","    tenableSecretKey = event['tenableSecretKeyParamName'];",
                        "\n","    tenableScanType = ssm.get_parameter(Name=event['tenableScanTypeParamName'])['Parameter']['Value'];",
                        "\n","    tenableScannerName = ssm.get_parameter(Name=event['tenableScannerParamName'])['Parameter']['Value'];",
                        "\n","    tenableApiUrl = event['tenableApiUrlParamName'];",
                        "\n","    instanceType = event['instanceType'];",
                        "\n","    amisJson =  ssm.get_parameter(Name=amisParamName)['Parameter']['Value']",
                        "\n","    items = amisJson.split(',')",
                        "\n","    instanceIDs = ''",
                        "\n","    for entry in items:",
                        "\n","        images= ec2.describe_images(ImageIds=[entry],DryRun=False)",
                        "\n","        if 'Tags' in images['Images'][0]:",
                        "\n","            tags = images['Images'][0]['Tags']",
                        "\n","            tags.append({'Key': 'continuous-assessment-instance', 'Value': 'true'})",
                        "\n","            response = ec2.run_instances(ImageId=entry,SubnetId='",{"Ref":"subnetPrivate"},"',IamInstanceProfile={'Arn':'", {"Fn::GetAtt" : ["ManagedInstanceProfile", "Arn"] }, "'},SecurityGroupIds=['",{"Ref":"secGroup"},"'],InstanceType=instanceType,DryRun=False,MaxCount=1,MinCount=1,TagSpecifications=[{'ResourceType': 'instance','Tags': tags}])",
                        "\n","        else:",
                        "\n","            response = ec2.run_instances(ImageId=entry,SubnetId='",{"Ref":"subnetPrivate"},"',IamInstanceProfile={'Arn':'", {"Fn::GetAtt" : ["ManagedInstanceProfile", "Arn"] }, "'}, SecurityGroupIds=['",{"Ref":"secGroup"},"'],InstanceType=instanceType,DryRun=False,MaxCount=1,MinCount=1,TagSpecifications=[{'ResourceType': 'instance','Tags': [{'Key': 'continuous-assessment-instance', 'Value': 'true'},{'Key': 'AMI-Type', 'Value': 'Golden'}]}])",
                        "\n","        if len(instanceIDs)==0:",
                        "\n","            instanceIDs=response['Instances'][0]['InstanceId']",
                        "\n","        else:",
                        "\n","            instanceIDs=instanceIDs+','+response['Instances'][0]['InstanceId']",

                        "\n","    print(\"Instances created \"+instanceIDs)",
                        "\n","    instanceID = instanceIDs.split(',')",
                        "\n","    for id in instanceID:",
                        "\n","        instance_details = ec2.describe_instances(",
                        "\n","            InstanceIds=[",
                        "\n","                'i-0cd48146bbc2506d1',",
                        "\n","                ]",
                        "\n","            DryRun= False,",
                        "\n","            )",
                        "\n","        for item in response['Reservations'][0]['Instances']:",
                        "\n","            if (item['PlatformDetails'] contains \"*inux\"):",
                        "\n","                ssm.start_automation_execution(DocumentName='",{"Ref":"RunLinuxContinuousInspection"},"', Parameters={'instanceIDs': [id], 'tenableApiKey':[tenableApiKey], 'tenableSecretKey':[tenableSecretKey], 'tenableScanType':[tenableScanType], 'tenableScannerName':[tenableScannerName], 'tenableApiUrl': [tenableApiUrl]})",
                        "\n","            elif (item['PlatformDetails'] contains \"*indows\")):",
                        "\n","                ssm.start_automation_execution(DocumentName='",{"Ref":"RunWindowsContinuousInspection"},"', Parameters={'instanceIDs': [id], 'tenableApiKey':[tenableApiKey], 'tenableSecretKey':[tenableSecretKey], 'tenableScanType':[tenableScanType], 'tenableScannerName':[tenableScannerName], 'tenableApiUrl': [tenableApiUrl]})",
                        "\n","    millis = int(round(time.time() * 1000))",
                        "\n","    return 'Assessment started'"

                      ]
                            ]
                         }
                      },
                      "Runtime":"python3.6",
                      "Timeout":300,
                      "Handler":"index.lambda_handler",
                      "MemorySize":512
                   }
          }


    },

    "Outputs": {
       "BucketName": {
            "Description": "The Name of the bucket created. Please upload template file in this bucket.",
            "Value": {
                "Ref": "GoldenAMIConfigBucket"
            }
        },

       "LinuxGoldenAMIAutomationDoc": {
            "Description": "The Name of the document that creates Golden AMI and executes nessus scanner based vulnerability scan.",
            "Value": {
                "Ref": "LinuxGoldenAMIAutomationDoc"
            }
        },

       "CopyAndShareAMIAutomationDoc": {
            "Description": "The Name of the document that copies and shares AMIs.",
            "Value": {
                "Ref": "CopyAndShareAMI"
            }
         },

       "SetupContinuousAssessmentLambdaFunction":{
         "Description":"The Lambda function that initiates the vulnerability assessment.",
         "Value":{
            "Ref":"SetupContinuousAssessmentLambdaFunction"
         }
        },

       "DecommissionAMIVersionDoc":{
         "Description":"The Name of the document that decomissions a golden AMI version.",
         "Value":{
            "Ref":"DecommissionAMIVersion"
          }
        },
       "ContinuousInspectionScheduledRule":{
         "Description":"The Cloudwatch rule that executes the continuous inspection at the rate you specified.",
         "Value":{
            "Ref":"ScheduledRule"
         }
        }
      }
}
